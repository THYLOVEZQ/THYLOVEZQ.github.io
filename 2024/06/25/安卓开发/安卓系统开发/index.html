<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>THYLOVEZQ的博客 | THYLOVEZQ的博客</title><meta name="author" content="THYLOVEZQ"><meta name="copyright" content="THYLOVEZQ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="[TOC] handler handler的原理 handler主要用来做线程通信。handler的核心是解决线程切换。 接下来，我们去实现一个Handler 123456789101112131415161718192021222324252627282930313233public class MainActivity extends AppCompatActivity implements">
<meta property="og:type" content="article">
<meta property="og:title" content="THYLOVEZQ的博客">
<meta property="og:url" content="http://example.com/2024/06/25/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91/%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="THYLOVEZQ的博客">
<meta property="og:description" content="[TOC] handler handler的原理 handler主要用来做线程通信。handler的核心是解决线程切换。 接下来，我们去实现一个Handler 123456789101112131415161718192021222324252627282930313233public class MainActivity extends AppCompatActivity implements">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2024-06-25T14:57:58.419Z">
<meta property="article:modified_time" content="2024-06-24T13:59:37.944Z">
<meta property="article:author" content="THYLOVEZQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/06/25/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91/%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'THYLOVEZQ的博客',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-24 21:59:37'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="THYLOVEZQ的博客" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/2.jfif" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">86</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">THYLOVEZQ的博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">无题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-25T14:57:58.419Z" title="发表于 2024-06-25 22:57:58">2024-06-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-24T13:59:37.944Z" title="更新于 2024-06-24 21:59:37">2024-06-24</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>[TOC]</p>
<h2 id="handler">handler</h2>
<h3 id="handler的原理">handler的原理</h3>
<p>handler主要用来做线程通信。handler的核心是解决线程切换。</p>
<p>接下来，我们去实现一个Handler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;MainActivity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Button registHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Handler mHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        registHandler = findViewById(R.id.button);</span><br><span class="line">        registHandler.setOnClickListener(<span class="keyword">this</span>::onClick);</span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;---&gt;&quot;</span> + msg.obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.button:</span><br><span class="line">                mHandler.sendMessage(<span class="keyword">new</span> Message(<span class="string">&quot;haoyu &quot;</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line">    String obj;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">(String obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">    xmlns:app=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="line">    xmlns:tools=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="line">    android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    tools:context=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;Button</span><br><span class="line">        android:id=<span class="string">&quot;@+id/button&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:text=<span class="string">&quot;发送消息&quot;</span></span><br><span class="line">        app:layout_constraintEnd_toEndOf=<span class="string">&quot;parent&quot;</span></span><br><span class="line">        app:layout_constraintStart_toStartOf=<span class="string">&quot;parent&quot;</span></span><br><span class="line">        app:layout_constraintTop_toTopOf=<span class="string">&quot;parent&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Button</span><br><span class="line">        android:id=<span class="string">&quot;@+id/button2&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:layout_marginTop=<span class="string">&quot;16dp&quot;</span></span><br><span class="line">        android:text=<span class="string">&quot;发送消息&quot;</span></span><br><span class="line">        app:layout_constraintEnd_toEndOf=<span class="string">&quot;parent&quot;</span></span><br><span class="line">        app:layout_constraintStart_toStartOf=<span class="string">&quot;parent&quot;</span></span><br><span class="line">        app:layout_constraintTop_toBottomOf=<span class="string">&quot;@+id/button&quot;</span> /&gt;</span><br><span class="line">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span><br></pre></td></tr></table></figure>
<p>但是，如果发送多条消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;MainActivity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Button registHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Handler mHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        registHandler = findViewById(R.id.button);</span><br><span class="line">        registHandler.setOnClickListener(<span class="keyword">this</span>::onClick);</span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;---&gt;&quot;</span> + msg.obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.button:</span><br><span class="line">                mHandler.sendMessage(<span class="keyword">new</span> Message(<span class="string">&quot;david &quot;</span>));</span><br><span class="line">                mHandler.sendMessage(<span class="keyword">new</span> Message(<span class="string">&quot;david &quot;</span>));</span><br><span class="line">                mHandler.sendMessage(<span class="keyword">new</span> Message(<span class="string">&quot;david &quot;</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果一条消息特别大，那么就会造成阻塞。我们可以使用生产者消费者模式进行优化：</p>
<p>我们可以在Handler中创建MessageQueue,并定义looper方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    MessageQueue messageQueue = <span class="keyword">new</span> MessageQueue();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">looper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Message msg = messageQueue.next();</span><br><span class="line">            handleMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        messageQueue.enqueueMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>MessageQueue的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageQueue</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    BlockingQueue&lt;Message&gt; queue = <span class="keyword">new</span> ArrayBlockingQueue&lt;Message&gt;(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * put = enqueueMessage</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            queue.put(msg);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Message <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Message msg = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            msg = queue.take();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的话，就可以解决在大量消息过来时，线程阻塞的问题了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;MainActivity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Button registHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler[] mHandler = &#123;<span class="keyword">null</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        registHandler = findViewById(R.id.button);</span><br><span class="line">        registHandler.setOnClickListener(<span class="keyword">this</span>::onClick);</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            mHandler[<span class="number">0</span>] = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;---&gt;&quot;</span> + msg.obj);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            mHandler[<span class="number">0</span>].looper();</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.button:</span><br><span class="line">                <span class="comment">// 处理不及时</span></span><br><span class="line">                <span class="comment">// 大量的消息过来，容易阻塞 oom</span></span><br><span class="line">                <span class="comment">// 不能做到线程通信</span></span><br><span class="line">                mHandler[<span class="number">0</span>].sendMessage(<span class="keyword">new</span> Message(<span class="string">&quot;david &quot;</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="binder">binder</h2>
<h3 id="为什么使用binder">为什么使用binder</h3>
<p>Linux中的进程通信有哪些：<strong>管道</strong>，<strong>共享内存</strong>，<strong>Socket</strong>，<strong>File</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>管道</th>
<th>binder</th>
<th>socket</th>
<th>共享内存</th>
</tr>
</thead>
<tbody>
<tr>
<td>效率</td>
<td>不高</td>
<td></td>
<td>不高</td>
<td>最高</td>
</tr>
<tr>
<td>安全</td>
<td>安全</td>
<td></td>
<td>安全</td>
<td>不安全</td>
</tr>
<tr>
<td>模型</td>
<td>一对一</td>
<td></td>
<td></td>
<td>N对N</td>
</tr>
</tbody>
</table>
<ol start="2">
<li>什么是用户空间，什么是内核空间<br>
应用程序运行在用户空间。两者不能简单地使用指针传递数据，<br>
因为Linux使用的虚拟内存机制，用户空间的数据可能被换出，<br>
当内核空间使用用户空间指针时，对应的数据可能不在内存中。用户空间的内存映射采用段页式</li>
</ol>
<h2 id="Framework">Framework</h2>
<h3 id="如何编译Android源码">如何编译Android源码</h3>
<ol>
<li>运行下面的脚本</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. build/envsetup.sh</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>lunch，选择6 aosp_x86_64</li>
<li>make ANDROID_COMPILE_WITH_JACK=false</li>
<li>执行emulator就可以出现安卓模拟器</li>
</ol>
<h3 id="哪些代码是运行在App进程的">哪些代码是运行在App进程的</h3>
<p>​	一般Android SDK里面的代码都是运行在我们APP进程的，一般SDK里面是android.jar。其实也就是我们编译出的framwork.jar，因为我们app需要依赖sdk才可以编译通过，说明各个app肯定会使用sdk中的代码，这个块代码属于所有app共用，故修改其中一个类就会影响所有的应用进程。</p>
<p>​	一般com.android.server.*相关的类都是运行在system_server，这一部分代码平时是接触不太到的，因为普通应用根本无法引入相关的server代码，因为这些代码属于system_server特殊应用自己的代码，普通应用只能通过跨进程通信的方式与其通信获取相关数据及接受控制，一般java代码对应的是services.jar。</p>
<h3 id="framework的编译产物">framework的编译产物</h3>
<p>在<code>/out/target/product/generic_x86_64/system/framework</code>该路径下，我们可以找到下面的jar包</p>
<ul>
<li>framework-res.apk：安卓系统资源库</li>
<li>framework.jar：android的sdk中核心代码</li>
<li>services.jar：框架层服务端的编译后jar包</li>
</ul>
<p><img src="E:%5Ccode%5Cdocs%5Cblogdocs%5C%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%5Cassets%5Cframework-jar%E5%8C%85.png" alt=""></p>
<p><img src="E:%5Ccode%5Cdocs%5Cblogdocs%5C%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%5Cassets%5Capp-system_server.png" alt=""></p>
<h3 id="Activity的启动">Activity的启动</h3>
<p>我们应该如何分析framework层代码的调用链呢，我们可以采用日志分析法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Log.i(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;onCreate&quot;</span>, <span class="keyword">new</span> Exception());</span><br></pre></td></tr></table></figure>
<p>在<code>/frameworks/base/core/java/android/app</code>路径下，我们可以找到<code>Activity.java</code>文件，我们在该类的<code>onCreate</code>方法中第一行打印上面的日志。</p>
<p>然后我们编译后，在命令行输入下面的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logcat | grep test</span><br></pre></td></tr></table></figure>
<p>随便点一个app，就会出现下面的日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">02-01 22:05:53.256  2169  2169 I test    : java.lang.Exception</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.app.Activity.onCreate(Activity.java:990)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.support.v4.app.SupportActivity.onCreate(SupportActivity.java:66)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.support.v4.app.FragmentActivity.onCreate(FragmentActivity.java:290)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.support.v7.app.AppCompatActivity.onCreate(AppCompatActivity.java:84)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at com.android.contacts.activities.AppCompatTransactionSafeActivity.onCreate(AppCompatTransactionSafeActivity.java:33)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at com.android.contacts.AppCompatContactsActivity.onCreate(AppCompatContactsActivity.java:81)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at com.android.contacts.activities.PeopleActivity.onCreate(PeopleActivity.java:352)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.app.Activity.performCreate(Activity.java:7000)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.app.Activity.performCreate(Activity.java:6991)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1214)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2731)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2856)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.app.ActivityThread.access$1300(ActivityThread.java:176)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1589)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at android.app.ActivityThread.main(ActivityThread.java:6494)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">02-01 22:05:53.256  2169  2169 I test    :      at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br></pre></td></tr></table></figure>
<p>我们从<code>ActivityThread</code>类的<code>handleLaunchActivity</code>入手进行分析：</p>
<p>分析后可以知道，在ActivityThread中，<code>handleLaunchActivity</code>方法调用了<code>performLaunchActivity</code>方法。而在<code>performLaunchActivity</code>方法中，调用了<code>Instrumentation</code>类的<code>callActivityOnCreate</code>方法。而在<code>callActivityOnCreate</code>方法中就会调用到<code>activity</code>的<code>performCreate</code>方法。</p>
<p>那么是谁调用了<code>handleLaunchActivity</code>方法？</p>
<p>我们重新查看<code>ActivityThread</code>类，在<code>ActivityThread</code>类中的<code>handleMessage</code>方法中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">case LAUNCH_ACTIVITY: &#123;</span><br><span class="line">	Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;activityStart&quot;);</span><br><span class="line">	final ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">	r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">	r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">	handleLaunchActivity(r, null, &quot;LAUNCH_ACTIVITY&quot;);</span><br><span class="line">	Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">&#125; break;</span><br></pre></td></tr></table></figure>
<p>然后再根据<code>LAUNCH_ACTIVITY</code>定位，可以找到<code>scheduleLaunchActivity</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="params"><span class="function">                ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span></span><br><span class="line"><span class="params"><span class="function">                CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span></span><br><span class="line"><span class="params"><span class="function">                List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line"></span><br><span class="line">            r.token = token;</span><br><span class="line">            r.ident = ident;</span><br><span class="line">            r.intent = intent;</span><br><span class="line">            r.referrer = referrer;</span><br><span class="line">            r.voiceInteractor = voiceInteractor;</span><br><span class="line">            r.activityInfo = info;</span><br><span class="line">            r.compatInfo = compatInfo;</span><br><span class="line">            r.state = state;</span><br><span class="line">            r.persistentState = persistentState;</span><br><span class="line"></span><br><span class="line">            r.pendingResults = pendingResults;</span><br><span class="line">            r.pendingIntents = pendingNewIntents;</span><br><span class="line"></span><br><span class="line">            r.startsNotResumed = notResumed;</span><br><span class="line">            r.isForward = isForward;</span><br><span class="line"></span><br><span class="line">            r.profilerInfo = profilerInfo;</span><br><span class="line"></span><br><span class="line">            r.overrideConfig = overrideConfig;</span><br><span class="line">            updatePendingConfiguration(curConfig);</span><br><span class="line"></span><br><span class="line">            sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在<code>scheduleLaunchActivity</code>方法中发送了<code>LAUNCH_ACTIVITY</code>消息，我们查找该方法发现，该方法是继承了<code>IApplicationThread.Stub</code>的内部类<code>ApplicationThread</code>中的方法，因此，有可能是通过跨进程通讯调用的该方法。</p>
<p>我们在<code>sendMessage</code>前加上一段log</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android.util.Log.d(<span class="string">&quot;test1&quot;</span>, <span class="string">&quot;scheduleLaunchActivity&quot;</span>, <span class="keyword">new</span> Exception());</span><br></pre></td></tr></table></figure>
<p>运行后可以发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">02-24 16:58:49.933  2509  2522 D test1   :      at android.app.ActivityThread$ApplicationThread.scheduleLaunchActivity(ActivityThread.java:787)</span><br><span class="line">02-24 16:58:49.933  2509  2522 D test1   :      at android.app.IApplicationThread$Stub.onTransact(IApplicationThread.java:196)</span><br><span class="line">02-24 16:58:49.933  2509  2522 D test1   :      at android.os.Binder.execTransact(Binder.java:697)</span><br></pre></td></tr></table></figure>
<p>但是，在堆栈上我们并不能找到是谁跨进程调用了<code>scheduleLaunchActivity</code>方法，我们可以在全局搜索是谁调用了<code>scheduleLaunchActivity</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;\.scheduleLaunchActivity&quot; ./ -rn</span><br></pre></td></tr></table></figure>
<p>我们可以得到以下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./services/core/java/com/android/server/am/ActivityStackSupervisor.java:1457:                app.thread.scheduleLaunchActivity(new Intent(r.intent), r.appToken,</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                        System.identityHashCode(r), r.info,</span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global</span></span><br><span class="line">                        <span class="comment">// and override configs.</span></span><br><span class="line">                        mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">                        mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">                        r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle,</span><br><span class="line">                        r.persistentState, results, newIntents, !andResume,</span><br><span class="line">                        mService.isNextTransitionForward(), profilerInfo);</span><br></pre></td></tr></table></figure>
<p><img src="E:%5Ccode%5Cdocs%5Cblogdocs%5C%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%5Cassets%5CApp%E8%BF%9B%E7%A8%8B%E6%B6%89%E5%8F%8A%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3%E8%BF%9B%E7%A8%8B.png" alt=""></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">######联系人进程调用startActivity，会最后调用AMS的startActivity</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : client execStartActivity</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : java.lang.Exception</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.app.Instrumentation.execStartActivity(Instrumentation.java:1611)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.app.Activity.startActivityForResult(Activity.java:4493)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.support.v4.app.BaseFragmentActivityApi16.startActivityForResult(BaseFragmentActivityApi16.java:54)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.support.v4.app.FragmentActivity.startActivityForResult(Unknown Source:0)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.app.Activity.startActivityForResult(Activity.java:4451)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.support.v4.app.FragmentActivity.startActivityForResult(FragmentActivity.java:725)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.app.Activity.startActivity(Activity.java:4812)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.app.Activity.startActivity(Activity.java:4780)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at com.android.contacts.util.ImplicitIntentsUtil.startActivityInApp(ImplicitIntentsUtil.java:82)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at com.android.contacts.util.AccountFilterUtil.startEditorIntent(AccountFilterUtil.java:205)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at com.android.contacts.activities.PeopleActivity$5.onClick(PeopleActivity.java:542)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.view.View.performClick(View.java:6294)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.view.View$PerformClick.run(View.java:24770)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.os.Handler.handleCallback(Handler.java:790)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.os.Handler.dispatchMessage(Handler.java:99)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at android.app.ActivityThread.main(ActivityThread.java:6494)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">07-18 16:56:49.770  2590  2590 I test1   : 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br><span class="line"></span><br><span class="line">##########System_server进程的AMS startActivity 打印，从方法堆栈在可以看出属于binder驱动调用，肯定无法看到联系人进程的堆栈</span><br><span class="line">07-18 16:56:49.774  1522  1533 I test1   : system_server startActivity callingPackage == com.android.contacts</span><br><span class="line">07-18 16:56:49.774  1522  1533 I test1   : java.lang.Exception</span><br><span class="line">07-18 16:56:49.774  1522  1533 I test1   : 	at com.android.server.am.ActivityManagerService.startActivity(ActivityManagerService.java:4519)</span><br><span class="line">07-18 16:56:49.774  1522  1533 I test1   : 	at android.app.IActivityManager$Stub.onTransact(IActivityManager.java:121)</span><br><span class="line">07-18 16:56:49.774  1522  1533 I test1   : 	at com.android.server.am.ActivityManagerService.onTransact(ActivityManagerService.java:2919)</span><br><span class="line">07-18 16:56:49.774  1522  1533 I test1   : 	at android.os.Binder.execTransact(Binder.java:697)</span><br><span class="line"></span><br><span class="line">##########System_server进程的AMS一切处理完毕，需要通知联系人进程拉起新的Activity</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : system_server app.thread.scheduleLaunchActivity</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : java.lang.Exception</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : 	at com.android.server.am.ActivityStackSupervisor.realStartActivityLocked(ActivityStackSupervisor.java:1457)</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : 	at com.android.server.am.ActivityStackSupervisor.startSpecificActivityLocked(ActivityStackSupervisor.java:1580)</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : 	at com.android.server.am.ActivityStack.resumeTopActivityInnerLocked(ActivityStack.java:2726)</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : 	at com.android.server.am.ActivityStack.resumeTopActivityUncheckedLocked(ActivityStack.java:2255)</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : 	at com.android.server.am.ActivityStackSupervisor.resumeFocusedStackTopActivityLocked(ActivityStackSupervisor.java:2094)</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : 	at com.android.server.am.ActivityStack.completePauseLocked(ActivityStack.java:1486)</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : 	at com.android.server.am.ActivityStack.activityPausedLocked(ActivityStack.java:1413)</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : 	at com.android.server.am.ActivityManagerService.activityPaused(ActivityManagerService.java:7442)</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : 	at android.app.IActivityManager$Stub.onTransact(IActivityManager.java:317)</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : 	at com.android.server.am.ActivityManagerService.onTransact(ActivityManagerService.java:2919)</span><br><span class="line">07-18 16:56:49.779  1522  1533 I test1   : 	at android.os.Binder.execTransact(Binder.java:697)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##########通过binder通信调用到了联系人进程的scheduleLaunchActivity方法</span><br><span class="line">07-18 16:56:49.800  2590  2703 D test1   : scheduleLaunchActivity</span><br><span class="line">07-18 16:56:49.800  2590  2703 D test1   : java.lang.Exception</span><br><span class="line">07-18 16:56:49.800  2590  2703 D test1   : 	at android.app.ActivityThread$ApplicationThread.scheduleLaunchActivity(ActivityThread.java:787)</span><br><span class="line">07-18 16:56:49.800  2590  2703 D test1   : 	at android.app.IApplicationThread$Stub.onTransact(IApplicationThread.java:196)</span><br><span class="line">07-18 16:56:49.800  2590  2703 D test1   : 	at android.os.Binder.execTransact(Binder.java:697)</span><br><span class="line"></span><br><span class="line">##########联系人应用的主线程调用Activity的onCreate方法</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : Activity onCreate</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : java.lang.Exception</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.app.Activity.onCreate(Activity.java:995)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.support.v4.app.SupportActivity.onCreate(SupportActivity.java:66)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.support.v4.app.FragmentActivity.onCreate(FragmentActivity.java:290)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.support.v7.app.AppCompatActivity.onCreate(AppCompatActivity.java:84)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at com.android.contacts.activities.AppCompatTransactionSafeActivity.onCreate(AppCompatTransactionSafeActivity.java:33)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at com.android.contacts.AppCompatContactsActivity.onCreate(AppCompatContactsActivity.java:81)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at com.android.contacts.activities.ContactEditorActivity.onCreate(ContactEditorActivity.java:315)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.app.Activity.performCreate(Activity.java:7005)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.app.Activity.performCreate(Activity.java:6996)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1214)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2731)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2856)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.app.ActivityThread.-wrap11(Unknown Source:0)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1589)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at android.app.ActivityThread.main(ActivityThread.java:6494)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">07-18 16:56:49.808  2590  2590 I test1   : 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br></pre></td></tr></table></figure>
<h3 id="实战开发-去除广告页">[实战开发]去除广告页</h3>
<p>先开发一个倒计时跳转的app：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TextView textView;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        textView = findViewById(R.id.tv_countdown);</span><br><span class="line">        <span class="keyword">new</span> CountDownTimer(<span class="number">10000</span>, <span class="number">1000</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTick</span><span class="params">(<span class="keyword">long</span> millisUntilFinished)</span> </span>&#123;</span><br><span class="line">                textView.setText(<span class="string">&quot;倒计时&quot;</span> + millisUntilFinished / <span class="number">1000</span> + <span class="string">&quot;秒&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFinish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, MainActivity2.class);</span><br><span class="line">                startActivity(intent);</span><br><span class="line">                finish();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设倒计时页面是我们删除的广告页面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys activity activities</span><br></pre></td></tr></table></figure>
<p>可以过滤一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys activity activities | grep &quot;Resumed&quot;</span><br></pre></td></tr></table></figure>
<p>可以得到广告页的Activity如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mResumedActivity: ActivityRecord&#123;fcb6ec3 u0 com.example.basic/.MainActivity t27&#125;</span><br><span class="line">ResumedActivity: ActivityRecord&#123;fcb6ec3 u0 com.example.basic/.MainActivity t27&#125;</span><br></pre></td></tr></table></figure>
<p>而我们可以找到主页的Activity如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mResumedActivity: ActivityRecord&#123;5ace1d u0 com.example.basic/.MainActivity2 t28&#125;</span><br><span class="line">ResumedActivity: ActivityRecord&#123;5ace1d u0 com.example.basic/.MainActivity2 t28&#125;</span><br></pre></td></tr></table></figure>
<p>dumpsys发现广告页面和主页面不是一个Activity，广告页面是第一个启动页面，然后会跳转到主页面。</p>
<p>故可以想到下面的去除广告页面的方式：</p>
<p>应用层 -&gt; 应用框架 -&gt; system_service顺序</p>
<ol>
<li>应用层：即启动广告页面的是Launcher这个应用，故是否可以考虑Launcher中修改。</li>
</ol>
<p>但是这里有一下两个问题：</p>
<ol>
<li>
<p>启动应用不一定在Launcher，在其他应用商店都是可以的</p>
</li>
<li>
<p>Launcher有可能装第三方的</p>
</li>
<li>
<p>应用框架：</p>
</li>
</ol>
<p>基本可以覆盖所有情况</p>
<p>优点：简单快捷，可以较快实现功能。</p>
<p>缺点：有可能破坏一些应用的初始化时序，故可能该方案不能针对所有带广告应用。</p>
<ol start="3">
<li>发现广告页面一般会有一个触摸点击跳过</li>
</ol>
<p>优点：最大限度保证广告自身逻辑</p>
<p>缺点：还是可以看到短暂广告，而且每个应用不一定都有跳过，而且跳过按钮可能不一定位置一样，导致无法满足覆盖所有应用，需要一个一个适配。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ComponentName inject = new ComponentName(&quot;com.example.basic&quot;, &quot;com.example.basic.MainActivity&quot;);</span><br><span class="line">ComponentName destComponent = new ComponentName(&quot;com.example.basic&quot;,&quot;com.example.basic.MainActivity2&quot;);</span><br><span class="line">android.util.Log.i(&quot;test2&quot;, &quot;startActivityForResult getComponent = &quot; + intent.getComponent());</span><br><span class="line">if (intent.getComponent() != null &amp;&amp; intent.getComponent().equals(inject))&#123;</span><br><span class="line">	intent.setComponent(destComponent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们还可以在Activity.java的dispatchTouchEvent方法中模拟ACTION_DOWN和ACTION_UP操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">injectClick</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        MotionEvent downMotion = MotionEvent.obtain(android.os.SystemClock.uptimeMillis(), 	android.os.SystemClock.uptimeMillis(), MotionEvent.ACTION_DOWN, x, y, <span class="number">0</span>);</span><br><span class="line">        dispatchTouchEvent(downMotion);</span><br><span class="line">        MotionEvent upMotion = MotionEvent.obtain(android.os.SystemClock.uptimeMillis(), android.os.SystemClock.uptimeMillis(), MotionEvent.ACTION_UP, x, y, <span class="number">0</span>);</span><br><span class="line">        mHandler.postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                                 <span class="meta">@Override</span></span><br><span class="line">                                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                     dispatchTouchEvent(upMotion);</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;,<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后在Activity的onResume方法中添加下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ComponentName srcCom = <span class="keyword">new</span> ComponentName(<span class="string">&quot;com.example.basic&quot;</span>, <span class="string">&quot;com.example.basic.MainActivity&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (srcCom.equals(getComponentName())) &#123;</span><br><span class="line">    mHandler.postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            injectClick(<span class="number">420</span>, <span class="number">52</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="如何将编译的系统放到Windows下执行">如何将编译的系统放到Windows下执行</h3>
<p>首先，我们需要知道编译的产物的路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/tanghaoyu/aosp/android-8.1.0_r1/out/target/product/generic_x86_64</span><br></pre></td></tr></table></figure>
<p>我们需要拷出下面的几个文件</p>
<ul>
<li>encryptionkey</li>
<li>kernel-ranchu</li>
<li>ramdisk.img</li>
<li>system-qemu.img</li>
<li>userdata.img</li>
<li>vendor-qemu.img</li>
</ul>
<p>利用Android Studio可以下载pixel的avd在下面的路径下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Admin\.android\avd\MyPhone.avd</span><br></pre></td></tr></table></figure>
<p>而下载的系统在下面的路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Admin\AppData\Local\Android\Sdk\system-images\android-27\default\x86_64</span><br></pre></td></tr></table></figure>
<h3 id="Android系统内置应用">Android系统内置应用</h3>
<p>系统定制的时候，经常会有遇到客户或者自己，想要集成某一个APP，但是又不想提供源码，只给APK。而且要做成不可卸载的app。</p>
<p>要将app做成系统app，需要以下三个步骤：</p>
<ul>
<li>在package/apps/目录下创建相应的文件夹如：MyAPP</li>
<li>在build/make/target/product/core.mk加入该Module名字</li>
<li>再进行整体的make就可以</li>
</ul>
<p>/packages/apps下存放着很多系统应用。</p>
<p>实战</p>
<p>Android系统内置APK作为系统应用分为两种情况：</p>
<ul>
<li>
<p>不带任何SO的应用</p>
</li>
<li>
<p>带有SO的应用</p>
</li>
<li>
<p>在/packages/apps放入Android.mk和MyApp.apk两个文件：</p>
</li>
</ul>
<p>其中Android.mk文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH:= $(call my-dir)</span><br><span class="line"></span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">$(warning &quot;MyApp of LOCAL_PATH is $(LOCAL_PATH)&quot;)#打印输出</span><br><span class="line"># Module name should match apk name to be installed</span><br><span class="line">LOCAL_MODULE := MyApp</span><br><span class="line">LOCAL_MODULE_TAGS := optional </span><br><span class="line">#不管是user 还是eng 版本都会编译此app</span><br><span class="line">LOCAL_SRC_FILES := $(LOCAL_MODULE).apk</span><br><span class="line">LOCAL_MODULE_CLASS := APPS</span><br><span class="line">LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)</span><br><span class="line">LOCAL_CERTIFICATE := PRESIGNED</span><br><span class="line">include $(BUILD_PREBUILT)</span><br></pre></td></tr></table></figure>
<h3 id="安卓开机动画">安卓开机动画</h3>
<h4 id="安卓开机动画开始源码分析">安卓开机动画开始源码分析</h4>
<p>请问大家在Android系统中要展示一个页面，不使用view方式还有没有其他方式</p>
<p>Android开机动画实现方式目前实现Android开机动画的方式主要是逐帧动画和OpenGL直接编程绘制动画。</p>
<p>逐帧动画：</p>
<p>逐帧动画是一种常见的动画形式，其原理是在&quot;连续的关键帧&quot;中分解动画动作。</p>
<p>逐帧动画实现原理是将一系列图片打包成bootanimation.zip放入/system/media/目录，系统将图片一帧一帧循环播放成一个动画。但是当bootanimation.zip大小大于5M的时候，动画将存在明显卡顿。文件越大动画越不流畅。</p>
<p>OpenGL动画</p>
<p>OpenGL是个定义了一个跨编程语言，跨平台的应用程序接口（API）的规范，它用于生成二维、三维图像。这个接口由近三百五十个不同的函数调用组成。</p>
<p>代码路径介绍：</p>
<p>与开机动画有关的主要有以下三个类：</p>
<p>bootanimation	/frameworks/base/cmds/bootanimation/</p>
<p>surfaceflinger	 /frameworks/native/services/surfaceflinger</p>
<p>init						/system/core/init</p>
<p>首先，我们进入到bootanimation文件夹下，查找Android.mk文件可以找到下面的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_MODULE:= bootanimation</span><br></pre></td></tr></table></figure>
<p>那么我们可以去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/tanghaoyu/aosp/android-8.1.0_r1/out/target/product/generic_x86_64/system/bin</span><br></pre></td></tr></table></figure>
<p>找到bootanimation</p>
<p>启动流程详细分析：</p>
<p>内核起来后会启动第一个进程，即init进程。</p>
<p>init进程不会根据init.rc配置启动bootanimation进程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">service bootanim /system/bin/bootanimation</span><br><span class="line">    class core animation</span><br><span class="line">    user graphics</span><br><span class="line">    group graphics audio</span><br><span class="line">    disabled // init.rc启动不会被拉起</span><br><span class="line">    oneshot</span><br><span class="line">    writepid /dev/stune/top-app/tasks</span><br></pre></td></tr></table></figure>
<p>而surfaceflinger则会启动：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">service surfaceflinger /system/bin/surfaceflinger</span><br><span class="line">    class core animation</span><br><span class="line">    user system</span><br><span class="line">    group graphics drmrpc readproc</span><br><span class="line">    onrestart restart zygote</span><br><span class="line">    writepid /dev/stune/foreground/tasks</span><br><span class="line">    socket pdx/system/vr/display/client     stream 0666 system graphics u:object_r:pdx_display_client_endpoint_socket:s0</span><br><span class="line">    socket pdx/system/vr/display/manager    stream 0666 system graphics u:object_r:pdx_display_manager_endpoint_socket:s0</span><br><span class="line">    socket pdx/system/vr/display/vsync      stream 0666 system graphics u:object_r:pdx_display_vsync_endpoint_socket:s0</span><br></pre></td></tr></table></figure>
<p>当surfaceflinger启动后，就会跟着跑进程的main函数：</p>
<p>main函数在如下文件中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/native/services/surfaceflinger/main_surfaceflinger.cpp</span><br></pre></td></tr></table></figure>
<p>源码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">char</span>**)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// instantiate surfaceflinger</span></span><br><span class="line">    sp&lt;SurfaceFlinger&gt; flinger = <span class="keyword">new</span> <span class="built_in">SurfaceFlinger</span>();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize before clients can connect</span></span><br><span class="line">    flinger-&gt;<span class="built_in">init</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// publish surface flinger</span></span><br><span class="line">    <span class="function">sp&lt;IServiceManager&gt; <span class="title">sm</span><span class="params">(defaultServiceManager())</span></span>;</span><br><span class="line">    sm-&gt;<span class="built_in">addService</span>(<span class="built_in">String16</span>(SurfaceFlinger::<span class="built_in">getServiceName</span>()), flinger, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// publish GpuService</span></span><br><span class="line">    sp&lt;GpuService&gt; gpuservice = <span class="keyword">new</span> <span class="built_in">GpuService</span>();</span><br><span class="line">    sm-&gt;<span class="built_in">addService</span>(<span class="built_in">String16</span>(GpuService::SERVICE_NAME), gpuservice, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// run surface flinger in this thread</span></span><br><span class="line">    flinger-&gt;<span class="built_in">run</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现，在该函数中，首先new一个SurfaceFlinger实例，然后init，然后run。</p>
<p>而我们可以继续跟踪SurfaceFlinger中的init方法：</p>
<p>代码路径位于下面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">void SurfaceFlinger::init() &#123;</span><br><span class="line">    ALOGI(  &quot;SurfaceFlinger&#x27;s main thread ready to run. &quot;</span><br><span class="line">            &quot;Initializing graphics H/W...&quot;);</span><br><span class="line"></span><br><span class="line">    ALOGI(&quot;Phase offest NS: %&quot; PRId64 &quot;&quot;, vsyncPhaseOffsetNs);</span><br><span class="line"></span><br><span class="line">    Mutex::Autolock _l(mStateLock);</span><br><span class="line"></span><br><span class="line">    // initialize EGL for the default display</span><br><span class="line">    mEGLDisplay = eglGetDisplay(EGL_DEFAULT_DISPLAY);</span><br><span class="line">    eglInitialize(mEGLDisplay, NULL, NULL);</span><br><span class="line"></span><br><span class="line">    // start the EventThread</span><br><span class="line">    sp&lt;VSyncSource&gt; vsyncSrc = new DispSyncSource(&amp;mPrimaryDispSync,</span><br><span class="line">            vsyncPhaseOffsetNs, true, &quot;app&quot;);</span><br><span class="line">    mEventThread = new EventThread(vsyncSrc, *this, false);</span><br><span class="line">    sp&lt;VSyncSource&gt; sfVsyncSrc = new DispSyncSource(&amp;mPrimaryDispSync,</span><br><span class="line">            sfVsyncPhaseOffsetNs, true, &quot;sf&quot;);</span><br><span class="line">    mSFEventThread = new EventThread(sfVsyncSrc, *this, true);</span><br><span class="line">    mEventQueue.setEventThread(mSFEventThread);</span><br><span class="line"></span><br><span class="line">    // set EventThread and SFEventThread to SCHED_FIFO to minimize jitter</span><br><span class="line">    struct sched_param param = &#123;0&#125;;</span><br><span class="line">    param.sched_priority = 2;</span><br><span class="line">    if (sched_setscheduler(mSFEventThread-&gt;getTid(), SCHED_FIFO, &amp;param) != 0) &#123;</span><br><span class="line">        ALOGE(&quot;Couldn&#x27;t set SCHED_FIFO for SFEventThread&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (sched_setscheduler(mEventThread-&gt;getTid(), SCHED_FIFO, &amp;param) != 0) &#123;</span><br><span class="line">        ALOGE(&quot;Couldn&#x27;t set SCHED_FIFO for EventThread&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Get a RenderEngine for the given display / config (can&#x27;t fail)</span><br><span class="line">    mRenderEngine = RenderEngine::create(mEGLDisplay,</span><br><span class="line">            HAL_PIXEL_FORMAT_RGBA_8888,</span><br><span class="line">            hasWideColorDisplay ? RenderEngine::WIDE_COLOR_SUPPORT : 0);</span><br><span class="line"></span><br><span class="line">    // retrieve the EGL context that was selected/created</span><br><span class="line">    mEGLContext = mRenderEngine-&gt;getEGLContext();</span><br><span class="line"></span><br><span class="line">    LOG_ALWAYS_FATAL_IF(mEGLContext == EGL_NO_CONTEXT,</span><br><span class="line">            &quot;couldn&#x27;t create EGLContext&quot;);</span><br><span class="line"></span><br><span class="line">    LOG_ALWAYS_FATAL_IF(mVrFlingerRequestsDisplay,</span><br><span class="line">            &quot;Starting with vr flinger active is not currently supported.&quot;);</span><br><span class="line">    mHwc.reset(new HWComposer(false));</span><br><span class="line">    mHwc-&gt;registerCallback(this, mComposerSequenceId);</span><br><span class="line"></span><br><span class="line">    if (useVrFlinger) &#123;</span><br><span class="line">        auto vrFlingerRequestDisplayCallback = [this] (bool requestDisplay) &#123;</span><br><span class="line">            // This callback is called from the vr flinger dispatch thread. We</span><br><span class="line">            // need to call signalTransaction(), which requires holding</span><br><span class="line">            // mStateLock when we&#x27;re not on the main thread. Acquiring</span><br><span class="line">            // mStateLock from the vr flinger dispatch thread might trigger a</span><br><span class="line">            // deadlock in surface flinger (see b/66916578), so post a message</span><br><span class="line">            // to be handled on the main thread instead.</span><br><span class="line">            sp&lt;LambdaMessage&gt; message = new LambdaMessage([=]() &#123;</span><br><span class="line">                ALOGI(&quot;VR request display mode: requestDisplay=%d&quot;, requestDisplay);</span><br><span class="line">                mVrFlingerRequestsDisplay = requestDisplay;</span><br><span class="line">                signalTransaction();</span><br><span class="line">            &#125;);</span><br><span class="line">            postMessageAsync(message);</span><br><span class="line">        &#125;;</span><br><span class="line">        mVrFlinger = dvr::VrFlinger::Create(mHwc-&gt;getComposer(),</span><br><span class="line">                                            vrFlingerRequestDisplayCallback);</span><br><span class="line">        if (!mVrFlinger) &#123;</span><br><span class="line">            ALOGE(&quot;Failed to start vrflinger&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mEventControlThread = new EventControlThread(this);</span><br><span class="line">    mEventControlThread-&gt;run(&quot;EventControl&quot;, PRIORITY_URGENT_DISPLAY);</span><br><span class="line"></span><br><span class="line">    // initialize our drawing state</span><br><span class="line">    mDrawingState = mCurrentState;</span><br><span class="line"></span><br><span class="line">    // set initial conditions (e.g. unblank default device)</span><br><span class="line">    initializeDisplays();</span><br><span class="line"></span><br><span class="line">    mRenderEngine-&gt;primeCache();</span><br><span class="line"></span><br><span class="line">    // Inform native graphics APIs whether the present timestamp is supported:</span><br><span class="line">    if (getHwComposer().hasCapability(</span><br><span class="line">            HWC2::Capability::PresentFenceIsNotReliable)) &#123;</span><br><span class="line">        mStartPropertySetThread = new StartPropertySetThread(false);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mStartPropertySetThread = new StartPropertySetThread(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (mStartPropertySetThread-&gt;Start() != NO_ERROR) &#123; // 真正启动设置bootanimation的属性线程</span><br><span class="line">        ALOGE(&quot;Run StartPropertySetThread failed!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ALOGV(&quot;Done initializing&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现启动了一个线程名为mStartPropertySetThread的start方法，我们进入StartPropertySetThread线程中查找start方法：</p>
<p>初始化graphics之后，mStartPropertySetThread()播放开机动画。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">status_t StartPropertySetThread::Start() &#123;</span><br><span class="line">    return run(&quot;SurfaceFlinger::StartPropertySetThread&quot;, PRIORITY_NORMAL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool StartPropertySetThread::threadLoop() &#123;</span><br><span class="line">    // Set property service.sf.present_timestamp, consumer need check its readiness</span><br><span class="line">    property_set(kTimestampProperty, mTimestampPropertyValue ? &quot;1&quot; : &quot;0&quot;);</span><br><span class="line">    // Clear BootAnimation exit flag</span><br><span class="line">    property_set(&quot;service.bootanim.exit&quot;, &quot;0&quot;); // 关键属性</span><br><span class="line">    // Start BootAnimation if not started</span><br><span class="line">    property_set(&quot;ctl.start&quot;, &quot;bootanim&quot;); // 关键属性</span><br><span class="line">    // Exit immediately</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么为什么设置了属性就可以启动bootanim进程，那么我们下面来看，/system/core/init/init.cpp，再看init进程的init.cpp的main函数中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">start_property_service</span>();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现main函数中执行了start_property_service函数，在/system/core/init/property_service.cpp：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">start_property_service</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">property_set</span>(<span class="string">&quot;ro.property_service.version&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    property_set_fd = <span class="built_in">CreateSocket</span>(PROP_SERVICE_NAME, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK,</span><br><span class="line">                                   <span class="literal">false</span>, <span class="number">0666</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">nullptr</span>, sehandle);</span><br><span class="line">    <span class="keyword">if</span> (property_set_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">PLOG</span>(ERROR) &lt;&lt; <span class="string">&quot;start_property_service socket creation failed&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">listen</span>(property_set_fd, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">register_epoll_handler</span>(property_set_fd, handle_property_set_fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个函数中注册了一个epoll handle的机制register_epoll_handler</p>
<p>init进程会使用epoll机制来轮询事件，当触发该事件后，会回调handle_property_set_fd方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">static void handle_property_set_fd() &#123;</span><br><span class="line">    static constexpr uint32_t kDefaultSocketTimeout = 2000; /* ms */</span><br><span class="line"></span><br><span class="line">    int s = accept4(property_set_fd, nullptr, nullptr, SOCK_CLOEXEC);</span><br><span class="line">    if (s == -1) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    struct ucred cr;</span><br><span class="line">    socklen_t cr_size = sizeof(cr);</span><br><span class="line">    if (getsockopt(s, SOL_SOCKET, SO_PEERCRED, &amp;cr, &amp;cr_size) &lt; 0) &#123;</span><br><span class="line">        close(s);</span><br><span class="line">        PLOG(ERROR) &lt;&lt; &quot;sys_prop: unable to get SO_PEERCRED&quot;;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SocketConnection socket(s, cr);</span><br><span class="line">    uint32_t timeout_ms = kDefaultSocketTimeout;</span><br><span class="line"></span><br><span class="line">    uint32_t cmd = 0;</span><br><span class="line">    if (!socket.RecvUint32(&amp;cmd, &amp;timeout_ms)) &#123;</span><br><span class="line">        PLOG(ERROR) &lt;&lt; &quot;sys_prop: error while reading command from the socket&quot;;</span><br><span class="line">        socket.SendUint32(PROP_ERROR_READ_CMD);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch (cmd) &#123;</span><br><span class="line">    case PROP_MSG_SETPROP: &#123;</span><br><span class="line">        char prop_name[PROP_NAME_MAX];</span><br><span class="line">        char prop_value[PROP_VALUE_MAX];</span><br><span class="line"></span><br><span class="line">        if (!socket.RecvChars(prop_name, PROP_NAME_MAX, &amp;timeout_ms) ||</span><br><span class="line">            !socket.RecvChars(prop_value, PROP_VALUE_MAX, &amp;timeout_ms)) &#123;</span><br><span class="line">          PLOG(ERROR) &lt;&lt; &quot;sys_prop(PROP_MSG_SETPROP): error while reading name/value from the socket&quot;;</span><br><span class="line">          return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        prop_name[PROP_NAME_MAX-1] = 0;</span><br><span class="line">        prop_value[PROP_VALUE_MAX-1] = 0;</span><br><span class="line"></span><br><span class="line">        handle_property_set(socket, prop_value, prop_value, true);</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    case PROP_MSG_SETPROP2: &#123;</span><br><span class="line">        std::string name;</span><br><span class="line">        std::string value;</span><br><span class="line">        if (!socket.RecvString(&amp;name, &amp;timeout_ms) ||</span><br><span class="line">            !socket.RecvString(&amp;value, &amp;timeout_ms)) &#123;</span><br><span class="line">          PLOG(ERROR) &lt;&lt; &quot;sys_prop(PROP_MSG_SETPROP2): error while reading name/value from the socket&quot;;</span><br><span class="line">          socket.SendUint32(PROP_ERROR_READ_DATA);</span><br><span class="line">          return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        handle_property_set(socket, name, value, false);</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    default:</span><br><span class="line">        LOG(ERROR) &lt;&lt; &quot;sys_prop: invalid command &quot; &lt;&lt; cmd;</span><br><span class="line">        socket.SendUint32(PROP_ERROR_INVALID_CMD);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而上面的方法会调用handle_property_set：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">static void handle_property_set(SocketConnection&amp; socket,</span><br><span class="line">                                const std::string&amp; name,</span><br><span class="line">                                const std::string&amp; value,</span><br><span class="line">                                bool legacy_protocol) &#123;</span><br><span class="line">  const char* cmd_name = legacy_protocol ? &quot;PROP_MSG_SETPROP&quot; : &quot;PROP_MSG_SETPROP2&quot;;</span><br><span class="line">  if (!is_legal_property_name(name)) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; &quot;sys_prop(&quot; &lt;&lt; cmd_name &lt;&lt; &quot;): illegal property name \&quot;&quot; &lt;&lt; name &lt;&lt; &quot;\&quot;&quot;;</span><br><span class="line">    socket.SendUint32(PROP_ERROR_INVALID_NAME);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  struct ucred cr = socket.cred();</span><br><span class="line">  char* source_ctx = nullptr;</span><br><span class="line">  getpeercon(socket.socket(), &amp;source_ctx);</span><br><span class="line"></span><br><span class="line">  if (android::base::StartsWith(name, &quot;ctl.&quot;)) &#123;</span><br><span class="line">    if (check_control_mac_perms(value.c_str(), source_ctx, &amp;cr)) &#123;</span><br><span class="line">      handle_control_message(name.c_str() + 4, value.c_str());</span><br><span class="line">      if (!legacy_protocol) &#123;</span><br><span class="line">        socket.SendUint32(PROP_SUCCESS);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      LOG(ERROR) &lt;&lt; &quot;sys_prop(&quot; &lt;&lt; cmd_name &lt;&lt; &quot;): Unable to &quot; &lt;&lt; (name.c_str() + 4)</span><br><span class="line">                 &lt;&lt; &quot; service ctl [&quot; &lt;&lt; value &lt;&lt; &quot;]&quot;</span><br><span class="line">                 &lt;&lt; &quot; uid:&quot; &lt;&lt; cr.uid</span><br><span class="line">                 &lt;&lt; &quot; gid:&quot; &lt;&lt; cr.gid</span><br><span class="line">                 &lt;&lt; &quot; pid:&quot; &lt;&lt; cr.pid;</span><br><span class="line">      if (!legacy_protocol) &#123;</span><br><span class="line">        socket.SendUint32(PROP_ERROR_HANDLE_CONTROL_MESSAGE);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    if (check_mac_perms(name, source_ctx, &amp;cr)) &#123;</span><br><span class="line">      uint32_t result = property_set(name, value);</span><br><span class="line">      if (!legacy_protocol) &#123;</span><br><span class="line">        socket.SendUint32(result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      LOG(ERROR) &lt;&lt; &quot;sys_prop(&quot; &lt;&lt; cmd_name &lt;&lt; &quot;): permission denied uid:&quot; &lt;&lt; cr.uid &lt;&lt; &quot; name:&quot; &lt;&lt; name;</span><br><span class="line">      if (!legacy_protocol) &#123;</span><br><span class="line">        socket.SendUint32(PROP_ERROR_PERMISSION_DENIED);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  freecon(source_ctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的方法调用了handle_control_message，该方法在system/core/init/init.cpp中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">void handle_control_message(const std::string&amp; msg, const std::string&amp; name) &#123;</span><br><span class="line">    Service* svc = ServiceManager::GetInstance().FindServiceByName(name);</span><br><span class="line">    if (svc == nullptr) &#123;</span><br><span class="line">        LOG(ERROR) &lt;&lt; &quot;no such service &#x27;&quot; &lt;&lt; name &lt;&lt; &quot;&#x27;&quot;;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (msg == &quot;start&quot;) &#123;</span><br><span class="line">        svc-&gt;Start();</span><br><span class="line">    &#125; else if (msg == &quot;stop&quot;) &#123;</span><br><span class="line">        svc-&gt;Stop();</span><br><span class="line">    &#125; else if (msg == &quot;restart&quot;) &#123;</span><br><span class="line">        svc-&gt;Restart();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        LOG(ERROR) &lt;&lt; &quot;unknown control msg &#x27;&quot; &lt;&lt; msg &lt;&lt; &quot;&#x27;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="E:%5Ccode%5Cdocs%5Cblogdocs%5C%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%5Cassets%5Cbootanimation%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png" alt=""></p>
<h4 id="开机动画的结束源码分析">开机动画的结束源码分析</h4>
<p>上节课，我们讲到bootanimation的main方法被执行，其中，main方法的代码位于<code>frameworks/base/cmds/bootanimation/bootanimation_main.cpp</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    setpriority(PRIO_PROCESS, 0, ANDROID_PRIORITY_DISPLAY);</span><br><span class="line"></span><br><span class="line">    bool noBootAnimation = bootAnimationDisabled();</span><br><span class="line">    ALOGI_IF(noBootAnimation,  &quot;boot animation disabled&quot;);</span><br><span class="line">    if (!noBootAnimation) &#123;</span><br><span class="line"></span><br><span class="line">        sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">        ProcessState::self()-&gt;startThreadPool();</span><br><span class="line"></span><br><span class="line">        waitForSurfaceFlinger();</span><br><span class="line"></span><br><span class="line">        // create the boot animation object</span><br><span class="line">        sp&lt;BootAnimation&gt; boot = new BootAnimation(new AudioAnimationCallbacks());</span><br><span class="line">        ALOGV(&quot;Boot animation set up. Joining pool.&quot;);</span><br><span class="line"></span><br><span class="line">        IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line">    ALOGV(&quot;Boot animation exit&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以分析，在main方法中，我们new出了BootAnimation对象，而BootAnimation的构造方法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BootAnimation::BootAnimation(sp &lt;Callbacks&gt; callbacks)</span><br><span class="line">        : Thread(false), mClockEnabled(true), mTimeIsAccurate(false),</span><br><span class="line">          mTimeFormat12Hour(false), mTimeCheckThread(NULL), mCallbacks(callbacks) &#123;</span><br><span class="line">    mSession = new SurfaceComposerClient();</span><br><span class="line"></span><br><span class="line">    std::string powerCtl = android::base::GetProperty(&quot;sys.powerctl&quot;, &quot;&quot;);</span><br><span class="line">    if (powerCtl.empty()) &#123;</span><br><span class="line">        mShuttingDown = false;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mShuttingDown = true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而可以看到，上述代码并没有进行什么重要的操作，我们回到main方法中，可以看到创建<code>BootAnimation</code>返回了一个智能指针，当返回该对象后，会调用<code>BootAnimation.cpp</code>中的<code>onFirstRef</code>方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void BootAnimation::onFirstRef() &#123;</span><br><span class="line">	status_t err = mSession-&gt;linkToComposerDeath(this);</span><br><span class="line">	ALOGE_IF(err, &quot;linkToComposerDeath failed (%s) &quot;, strerror(-err));</span><br><span class="line">	if (err == NO_ERROR) &#123;</span><br><span class="line">		run(&quot;BootAnimation&quot;, PRIORITY_DISPLAY);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到执行了一个run方法。那么我们可以推测是不是BootAnimation本身就是一个线程类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class BootAnimation : public Thread, public IBinder::DeathRecipient</span><br></pre></td></tr></table></figure>
<p>而run方法则先会调用下面的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">status_t BootAnimation::readyToRun() &#123;</span><br><span class="line">        mAssets.addDefaultAssets();</span><br><span class="line"></span><br><span class="line">        sp &lt;IBinder&gt; dtoken(SurfaceComposerClient::getBuiltInDisplay(</span><br><span class="line">                ISurfaceComposer::eDisplayIdMain));</span><br><span class="line">        DisplayInfo dinfo;</span><br><span class="line">        status_t status = SurfaceComposerClient::getDisplayInfo(dtoken, &amp;dinfo);</span><br><span class="line">        if (status)</span><br><span class="line">            return -1;</span><br><span class="line"></span><br><span class="line">        // create the native surface</span><br><span class="line">        sp &lt;SurfaceControl&gt; control = session()-&gt;createSurface(String8(&quot;BootAnimation&quot;),</span><br><span class="line">                                                               dinfo.w, dinfo.h,</span><br><span class="line">                                                               PIXEL_FORMAT_RGB_565);</span><br><span class="line"></span><br><span class="line">        SurfaceComposerClient::openGlobalTransaction();</span><br><span class="line">        control-&gt;setLayer(0x40000000);</span><br><span class="line">        SurfaceComposerClient::closeGlobalTransaction();</span><br><span class="line"></span><br><span class="line">        sp &lt;Surface&gt; s = control-&gt;getSurface();</span><br><span class="line"></span><br><span class="line">        // initialize opengl and egl</span><br><span class="line">        const EGLint attribs[] = &#123;</span><br><span class="line">                EGL_RED_SIZE, 8,</span><br><span class="line">                EGL_GREEN_SIZE, 8,</span><br><span class="line">                EGL_BLUE_SIZE, 8,</span><br><span class="line">                EGL_DEPTH_SIZE, 0,</span><br><span class="line">                EGL_NONE</span><br><span class="line">        &#125;;</span><br><span class="line">        EGLint w, h;</span><br><span class="line">        EGLint numConfigs;</span><br><span class="line">        EGLConfig config;</span><br><span class="line">        EGLSurface surface;</span><br><span class="line">        EGLContext context;</span><br><span class="line"></span><br><span class="line">        EGLDisplay display = eglGetDisplay(EGL_DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">        eglInitialize(display, 0, 0);</span><br><span class="line">        eglChooseConfig(display, attribs, &amp;config, 1, &amp;numConfigs);</span><br><span class="line">        surface = eglCreateWindowSurface(display, config, s.get(), NULL);</span><br><span class="line">        context = eglCreateContext(display, config, NULL, NULL);</span><br><span class="line">        eglQuerySurface(display, surface, EGL_WIDTH, &amp;w);</span><br><span class="line">        eglQuerySurface(display, surface, EGL_HEIGHT, &amp;h);</span><br><span class="line"></span><br><span class="line">        if (eglMakeCurrent(display, surface, surface, context) == EGL_FALSE)</span><br><span class="line">            return NO_INIT;</span><br><span class="line"></span><br><span class="line">        mDisplay = display;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mSurface = surface;</span><br><span class="line">        mWidth = w;</span><br><span class="line">        mHeight = h;</span><br><span class="line">        mFlingerSurfaceControl = control;</span><br><span class="line">        mFlingerSurface = s;</span><br><span class="line"></span><br><span class="line">        // If the device has encryption turned on or is in process</span><br><span class="line">        // of being encrypted we show the encrypted boot animation.</span><br><span class="line">        char decrypt[PROPERTY_VALUE_MAX];</span><br><span class="line">        property_get(&quot;vold.decrypt&quot;, decrypt, &quot;&quot;);</span><br><span class="line"></span><br><span class="line">        bool encryptedAnimation = atoi(decrypt) != 0 ||</span><br><span class="line">                                  !strcmp(&quot;trigger_restart_min_framework&quot;, decrypt);</span><br><span class="line"></span><br><span class="line">        if (!mShuttingDown &amp;&amp; encryptedAnimation &amp;&amp;</span><br><span class="line">            (access(SYSTEM_ENCRYPTED_BOOTANIMATION_FILE, R_OK) == 0)) &#123;</span><br><span class="line">            mZipFileName = SYSTEM_ENCRYPTED_BOOTANIMATION_FILE;</span><br><span class="line">            return NO_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        static const char *bootFiles[] = &#123;OEM_BOOTANIMATION_FILE, SYSTEM_BOOTANIMATION_FILE&#125;;</span><br><span class="line">        static const char *shutdownFiles[] =</span><br><span class="line">                &#123;OEM_SHUTDOWNANIMATION_FILE, SYSTEM_SHUTDOWNANIMATION_FILE&#125;;</span><br><span class="line"></span><br><span class="line">        for (const char *f: (!mShuttingDown ? bootFiles : shutdownFiles)) &#123;</span><br><span class="line">            if (access(f, R_OK) == 0) &#123;</span><br><span class="line">                mZipFileName = f;</span><br><span class="line">                return NO_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return NO_ERROR;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，在上述代码中，我们主要构建了画布，初始化opengl，检测file是否存在。同时将mZipFileName赋值，可以发现我们的开机动画文件位于<code>/oem/media/bootanimation.zip</code>和<code>/system/media/bootanimation.zip</code>。</p>
<p>在执行完<code>readyToRun</code>方法后，就会执行<code>threadLoop</code>方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bool BootAnimation::threadLoop() &#123;</span><br><span class="line">    bool r;</span><br><span class="line">    // We have no bootanimation file, so we use the stock android logo</span><br><span class="line">    // animation.</span><br><span class="line">    if (mZipFileName.isEmpty()) &#123;</span><br><span class="line">    	r = android();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    	r = movie();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    eglMakeCurrent(mDisplay, EGL_NO_SURFACE, EGL_NO_SURFACE, EGL_NO_CONTEXT);</span><br><span class="line">    eglDestroyContext(mDisplay, mContext);</span><br><span class="line">    eglDestroySurface(mDisplay, mSurface);</span><br><span class="line">    mFlingerSurface.clear();</span><br><span class="line">    mFlingerSurfaceControl.clear();</span><br><span class="line">    eglTerminate(mDisplay);</span><br><span class="line">    eglReleaseThread();</span><br><span class="line">    IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">    return r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，当mZipFileName不为空时。就会调用android方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">bool BootAnimation::android() &#123;</span><br><span class="line">        ALOGD(&quot;%sAnimationShownTiming start time: %&quot;</span><br><span class="line">        PRId64</span><br><span class="line">        &quot;ms&quot;, mShuttingDown ? &quot;Shutdown&quot; : &quot;Boot&quot;,</span><br><span class="line">                elapsedRealtime());</span><br><span class="line">        initTexture(&amp;mAndroid[0], mAssets, &quot;images/android-logo-mask.png&quot;);</span><br><span class="line">        initTexture(&amp;mAndroid[1], mAssets, &quot;images/android-logo-shine.png&quot;);</span><br><span class="line"></span><br><span class="line">        mCallbacks-&gt;init(&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        // clear screen</span><br><span class="line">        glShadeModel(GL_FLAT);</span><br><span class="line">        glDisable(GL_DITHER);</span><br><span class="line">        glDisable(GL_SCISSOR_TEST);</span><br><span class="line">        glClearColor(0, 0, 0, 1);</span><br><span class="line">        glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line">        eglSwapBuffers(mDisplay, mSurface);</span><br><span class="line"></span><br><span class="line">        glEnable(GL_TEXTURE_2D);</span><br><span class="line">        glTexEnvx(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_REPLACE);</span><br><span class="line"></span><br><span class="line">        const GLint xc = (mWidth - mAndroid[0].w) / 2;</span><br><span class="line">        const GLint yc = (mHeight - mAndroid[0].h) / 2;</span><br><span class="line">        const Rect updateRect(xc, yc, xc + mAndroid[0].w, yc + mAndroid[0].h);</span><br><span class="line"></span><br><span class="line">        glScissor(updateRect.left, mHeight - updateRect.bottom, updateRect.width(),</span><br><span class="line">                  updateRect.height());</span><br><span class="line"></span><br><span class="line">        // Blend state</span><br><span class="line">        glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line">        glTexEnvx(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_REPLACE);</span><br><span class="line"></span><br><span class="line">        const nsecs_t startTime = systemTime();</span><br><span class="line">        do &#123;</span><br><span class="line">            nsecs_t now = systemTime();</span><br><span class="line">            double time = now - startTime;</span><br><span class="line">            float t = 4.0f * float(time / us2ns(16667)) / mAndroid[1].w;</span><br><span class="line">            GLint offset = (1 - (t - floorf(t))) * mAndroid[1].w;</span><br><span class="line">            GLint x = xc - offset;</span><br><span class="line"></span><br><span class="line">            glDisable(GL_SCISSOR_TEST);</span><br><span class="line">            glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">            glEnable(GL_SCISSOR_TEST);</span><br><span class="line">            glDisable(GL_BLEND);</span><br><span class="line">            glBindTexture(GL_TEXTURE_2D, mAndroid[1].name);</span><br><span class="line">            glDrawTexiOES(x, yc, 0, mAndroid[1].w, mAndroid[1].h);</span><br><span class="line">            glDrawTexiOES(x + mAndroid[1].w, yc, 0, mAndroid[1].w, mAndroid[1].h);</span><br><span class="line"></span><br><span class="line">            glEnable(GL_BLEND);</span><br><span class="line">            glBindTexture(GL_TEXTURE_2D, mAndroid[0].name);</span><br><span class="line">            glDrawTexiOES(xc, yc, 0, mAndroid[0].w, mAndroid[0].h);</span><br><span class="line"></span><br><span class="line">            EGLBoolean res = eglSwapBuffers(mDisplay, mSurface);</span><br><span class="line">            if (res == EGL_FALSE)</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            // 12fps: don&#x27;t animate too fast to preserve CPU</span><br><span class="line">            const nsecs_t sleepTime = 83333 - ns2us(systemTime() - now);</span><br><span class="line">            if (sleepTime &gt; 0)</span><br><span class="line">                usleep(sleepTime);</span><br><span class="line"></span><br><span class="line">            checkExit();</span><br><span class="line">        &#125; while (!exitPending());</span><br><span class="line"></span><br><span class="line">        glDeleteTextures(1, &amp;mAndroid[0].name);</span><br><span class="line">        glDeleteTextures(1, &amp;mAndroid[1].name);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>而android方法中，checkExit方法值得注意：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void BootAnimation::checkExit() &#123;</span><br><span class="line">	// Allow surface flinger to gracefully request shutdown</span><br><span class="line">	char value[PROPERTY_VALUE_MAX];</span><br><span class="line">	property_get(EXIT_PROP_NAME, value, &quot;0&quot;);</span><br><span class="line">	int exitnow = atoi(value);</span><br><span class="line">	if (exitnow) &#123;</span><br><span class="line">		requestExit();</span><br><span class="line">		mCallbacks-&gt;shutdown();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，当<code>EXIT_PROP_NAME</code>属性为退出状态时，程序就会退出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static const char EXIT_PROP_NAME[] = &quot;service.bootanim.exit&quot;;</span><br></pre></td></tr></table></figure>
<p>我们在源码路径中寻找上面的属性，可以找到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./services/core/java/com/android/server/wm/WindowManagerService.java:3509:                SystemProperties.set(&quot;service.bootanim.exit&quot;, &quot;1&quot;);</span><br><span class="line"></span><br><span class="line">./native/services/surfaceflinger/SurfaceFlinger.cpp:388:    property_set(&quot;service.bootanim.exit&quot;, &quot;1&quot;);</span><br></pre></td></tr></table></figure>
<p>可以检索到有两处设置了service.bootanim.exit。我们先去看<code>com.android.server.wm.WindowManagerService</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">private void performEnableScreen() &#123;</span><br><span class="line">        synchronized(mWindowMap) &#123;</span><br><span class="line">            if (DEBUG_BOOT) Slog.i(TAG_WM, &quot;performEnableScreen: mDisplayEnabled=&quot; + mDisplayEnabled</span><br><span class="line">                    + &quot; mForceDisplayEnabled=&quot; + mForceDisplayEnabled</span><br><span class="line">                    + &quot; mShowingBootMessages=&quot; + mShowingBootMessages</span><br><span class="line">                    + &quot; mSystemBooted=&quot; + mSystemBooted</span><br><span class="line">                    + &quot; mOnlyCore=&quot; + mOnlyCore,</span><br><span class="line">                    new RuntimeException(&quot;here&quot;).fillInStackTrace());</span><br><span class="line">            if (mDisplayEnabled) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            if (!mSystemBooted &amp;&amp; !mShowingBootMessages) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!mShowingBootMessages &amp;&amp; !mPolicy.canDismissBootAnimation()) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Don&#x27;t enable the screen until all existing windows have been drawn.</span><br><span class="line">            if (!mForceDisplayEnabled</span><br><span class="line">                    // TODO(multidisplay): Expand to all displays?</span><br><span class="line">                    &amp;&amp; getDefaultDisplayContentLocked().checkWaitingForWindows()) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!mBootAnimationStopped) &#123;</span><br><span class="line">                Trace.asyncTraceBegin(TRACE_TAG_WINDOW_MANAGER, &quot;Stop bootanim&quot;, 0);</span><br><span class="line">                // stop boot animation</span><br><span class="line">                // formerly we would just kill the process, but we now ask it to exit so it</span><br><span class="line">                // can choose where to stop the animation.</span><br><span class="line">                SystemProperties.set(&quot;service.bootanim.exit&quot;, &quot;1&quot;);</span><br><span class="line">                mBootAnimationStopped = true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!mForceDisplayEnabled &amp;&amp; !checkBootAnimationCompleteLocked()) &#123;</span><br><span class="line">                if (DEBUG_BOOT) Slog.i(TAG_WM, &quot;performEnableScreen: Waiting for anim complete&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                IBinder surfaceFlinger = ServiceManager.getService(&quot;SurfaceFlinger&quot;);</span><br><span class="line">                if (surfaceFlinger != null) &#123;</span><br><span class="line">                    Slog.i(TAG_WM, &quot;******* TELLING SURFACE FLINGER WE ARE BOOTED!&quot;);</span><br><span class="line">                    Parcel data = Parcel.obtain();</span><br><span class="line">                    data.writeInterfaceToken(&quot;android.ui.ISurfaceComposer&quot;);</span><br><span class="line">                    surfaceFlinger.transact(IBinder.FIRST_CALL_TRANSACTION, // BOOT_FINISHED</span><br><span class="line">                            data, null, 0);</span><br><span class="line">                    data.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                Slog.e(TAG_WM, &quot;Boot completed: SurfaceFlinger is dead!&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            EventLog.writeEvent(EventLogTags.WM_BOOT_ANIMATION_DONE, SystemClock.uptimeMillis());</span><br><span class="line">            Trace.asyncTraceEnd(TRACE_TAG_WINDOW_MANAGER, &quot;Stop bootanim&quot;, 0);</span><br><span class="line">            mDisplayEnabled = true;</span><br><span class="line">            if (DEBUG_SCREEN_ON || DEBUG_BOOT) Slog.i(TAG_WM, &quot;******************** ENABLING SCREEN!&quot;);</span><br><span class="line"></span><br><span class="line">            // Enable input dispatch.</span><br><span class="line">            mInputMonitor.setEventDispatchingLw(mEventDispatchingEnabled);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            mActivityManager.bootAnimationComplete();</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mPolicy.enableScreenAfterBoot();</span><br><span class="line"></span><br><span class="line">        // Make sure the last requested orientation has been applied.</span><br><span class="line">        updateRotationUnchecked(false, false);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>那么，我们需要去分析一下是谁调用了performEnableScreen方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">![bootanimation结束源码流程](E:\code\docs\blogdocs\安卓开发\assets\bootanimation结束源码流程.png)日志打印分析：</span><br><span class="line"></span><br><span class="line">03-09 00:53:27.569  1712  1712 I lsm2    : Scheduling idle handler for ActivityRecord&#123;5c8f360 token=android.os.BinderProxy@6d26d5c &#123;com.android.settings/com.android.settings.FallbackHome&#125;&#125;</span><br><span class="line">//1、进入idle</span><br><span class="line">03-09 00:53:27.687  1712  1712 I lsm2    :  activityIdle a.activity ComponentInfo&#123;com.android.settings/com.android.settings.FallbackHome&#125;</span><br><span class="line">//2、跨进程调用到AMS中，执行了postFinishBooting</span><br><span class="line">03-09 00:53:27.941  1529  1584 D lsm2    : postFinishBooting finishBooting true enableScreen true</span><br><span class="line">03-09 00:53:27.941  1529  1584 D lsm2    : java.lang.Exception</span><br><span class="line">03-09 00:53:27.941  1529  1584 D lsm2    : 	at com.android.server.am.ActivityManagerService.postFinishBooting(ActivityManagerService.java:7244)</span><br><span class="line">03-09 00:53:27.941  1529  1584 D lsm2    : 	at com.android.server.am.ActivityStackSupervisor.checkFinishBootingLocked(ActivityStackSupervisor.java:1874)</span><br><span class="line">03-09 00:53:27.941  1529  1584 D lsm2    : 	at com.android.server.am.ActivityStackSupervisor.activityIdleInternalLocked(ActivityStackSupervisor.java:1916)</span><br><span class="line">03-09 00:53:27.941  1529  1584 D lsm2    : 	at com.android.server.am.ActivityManagerService.activityIdle(ActivityManagerService.java:7231)</span><br><span class="line">03-09 00:53:27.941  1529  1584 D lsm2    : 	at android.app.IActivityManager$Stub.onTransact(IActivityManager.java:309)</span><br><span class="line">03-09 00:53:27.941  1529  1584 D lsm2    : 	at com.android.server.am.ActivityManagerService.onTransact(ActivityManagerService.java:2919)</span><br><span class="line">03-09 00:53:27.941  1529  1584 D lsm2    : 	at android.os.Binder.execTransact(Binder.java:697)</span><br><span class="line">//3、调用到WMS中的performEnableScreen</span><br><span class="line">03-09 00:52:44.223  1529  1552 D lsm2    :  WindowManagerService performEnableScreen Stop bootanim</span><br><span class="line">03-09 00:52:44.223  1529  1552 D lsm2    : java.lang.Exception</span><br><span class="line">03-09 00:52:44.223  1529  1552 D lsm2    : 	at com.android.server.wm.WindowManagerService.performEnableScreen(WindowManagerService.java:3511)</span><br><span class="line">03-09 00:52:44.223  1529  1552 D lsm2    : 	at com.android.server.wm.WindowManagerService.-wrap6(Unknown Source:0)</span><br><span class="line">03-09 00:52:44.223  1529  1552 D lsm2    : 	at com.android.server.wm.WindowManagerService$H.handleMessage(WindowManagerService.java:5065)</span><br><span class="line">03-09 00:52:44.223  1529  1552 D lsm2    : 	at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">03-09 00:52:44.223  1529  1552 D lsm2    : 	at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">03-09 00:52:44.223  1529  1552 D lsm2    : 	at android.os.HandlerThread.run(HandlerThread.java:65)</span><br><span class="line">03-09 00:52:44.223  1529  1552 D lsm2    : 	at com.android.server.ServiceThread.run(ServiceThread.java:46)</span><br><span class="line">//4、跨进程调用到SurfaceFlinger</span><br><span class="line">03-09 00:52:44.310  1529  1552 D lsm2    :  WindowManagerService performEnableScreen  surfaceFlinger.transact(IBinder.FIRST_CALL_TRANSACTION </span><br><span class="line">//5、SurfaceFlinger执行prop的设置</span><br><span class="line">03-09 00:52:44.311  1368  1594 I SurfaceFlinger: lsm2 SurfaceFlinger service.bootanim.exit 1 </span><br><span class="line">03-09 00:52:45.573  2014  2014 I lsm2    : Scheduling idle handler for ActivityRecord&#123;f5df6ba token=android.os.BinderProxy@80709eb &#123;com.android.launcher/com.android.launcher2.Launcher&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>总结bootanimation的结束源码流程：</p>
<p><img src="E:%5Ccode%5Cdocs%5Cblogdocs%5C%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%5Cassets%5Cbootanimation%E7%BB%93%E6%9D%9F%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.png" alt=""></p>
<h4 id="开机动画openGL绘制分析及实战">开机动画openGL绘制分析及实战</h4>
<p><img src="E:%5Ccode%5Cdocs%5Cblogdocs%5C%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%5Cassets%5Copengl_draw%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>我们可以在开机动画上加一个时间</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">void BootAnimation::drawClock(const Font &amp;font, const int xPos, const int yPos) &#123;</span><br><span class="line">        static constexpr char TIME_FORMAT_12[] = &quot;%l:%M&quot;;</span><br><span class="line">        static constexpr char TIME_FORMAT_24[] = &quot;%H:%M&quot;;</span><br><span class="line">        static constexpr int TIME_LENGTH = 6;</span><br><span class="line"></span><br><span class="line">        time_t rawtime;</span><br><span class="line">        time(&amp;rawtime);</span><br><span class="line">        struct tm *timeInfo = localtime(&amp;rawtime);</span><br><span class="line"></span><br><span class="line">        char timeBuff[TIME_LENGTH];</span><br><span class="line">        const char *timeFormat = mTimeFormat12Hour ? TIME_FORMAT_12 : TIME_FORMAT_24;</span><br><span class="line">        size_t length = strftime(timeBuff, TIME_LENGTH, timeFormat, timeInfo);</span><br><span class="line"></span><br><span class="line">        if (length != TIME_LENGTH - 1) &#123;</span><br><span class="line">            ALOGE(&quot;Couldn&#x27;t format time; abandoning boot animation clock&quot;);</span><br><span class="line">            mClockEnabled = false;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        char *out = timeBuff[0] == &#x27; &#x27; ? &amp;timeBuff[1] : &amp;timeBuff[0];</span><br><span class="line">        int x = xPos;</span><br><span class="line">        int y = yPos;</span><br><span class="line">        drawText(out, font, false, &amp;x, &amp;y);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在<code>BootAnimation.cpp</code>中有一个<code>drawClock</code>方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">void BootAnimation::drawClock(const Font &amp;font, const int xPos, const int yPos) &#123;</span><br><span class="line">    static constexpr char TIME_FORMAT_12[] = &quot;%l:%M&quot;;</span><br><span class="line">    static constexpr char TIME_FORMAT_24[] = &quot;%H:%M&quot;;</span><br><span class="line">    static constexpr int TIME_LENGTH = 6;</span><br><span class="line"></span><br><span class="line">    time_t rawtime;</span><br><span class="line">    time(&amp;rawtime);</span><br><span class="line">    struct tm *timeInfo = localtime(&amp;rawtime);</span><br><span class="line"></span><br><span class="line">    char timeBuff[TIME_LENGTH];</span><br><span class="line">    const char *timeFormat = mTimeFormat12Hour ? TIME_FORMAT_12 : TIME_FORMAT_24;</span><br><span class="line">    size_t length = strftime(timeBuff, TIME_LENGTH, timeFormat, timeInfo);</span><br><span class="line"></span><br><span class="line">    if (length != TIME_LENGTH - 1) &#123;</span><br><span class="line">    ALOGE(&quot;Couldn&#x27;t format time; abandoning boot animation clock&quot;);</span><br><span class="line">    mClockEnabled = false;</span><br><span class="line">    return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    char *out = timeBuff[0] == &#x27; &#x27; ? &amp;timeBuff[1] : &amp;timeBuff[0];</span><br><span class="line">    int x = xPos;</span><br><span class="line">    int y = yPos;</span><br><span class="line">    drawText(out, font, false, &amp;x, &amp;y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到产生了时钟字符串然后调用drawText进行绘制：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">void BootAnimation::drawText(const char *str, const Font &amp;font, bool bold, int *x, int *y) &#123;</span><br><span class="line">        glEnable(GL_BLEND);  // Allow us to draw on top of the animation</span><br><span class="line">        glBindTexture(GL_TEXTURE_2D, font.texture.name);</span><br><span class="line"></span><br><span class="line">        const int len = strlen(str);</span><br><span class="line">        const int strWidth = font.char_width * len;</span><br><span class="line"></span><br><span class="line">        if (*x == TEXT_CENTER_VALUE) &#123;</span><br><span class="line">            *x = (mWidth - strWidth) / 2;</span><br><span class="line">        &#125; else if (*x &lt; 0) &#123;</span><br><span class="line">            *x = mWidth + *x - strWidth;</span><br><span class="line">        &#125;</span><br><span class="line">        if (*y == TEXT_CENTER_VALUE) &#123;</span><br><span class="line">            *y = (mHeight - font.char_height) / 2;</span><br><span class="line">        &#125; else if (*y &lt; 0) &#123;</span><br><span class="line">            *y = mHeight + *y - font.char_height;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int cropRect[4] = &#123;0, 0, font.char_width, -font.char_height&#125;;</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; len; i++) &#123;</span><br><span class="line">            char c = str[i];</span><br><span class="line"></span><br><span class="line">            if (c &lt; FONT_BEGIN_CHAR || c &gt; FONT_END_CHAR) &#123;</span><br><span class="line">                c = &#x27;?&#x27;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Crop the texture to only the pixels in the current glyph</span><br><span class="line">            const int charPos = (c - FONT_BEGIN_CHAR);  // Position in the list of valid characters</span><br><span class="line">            const int row = charPos / FONT_NUM_COLS;</span><br><span class="line">            const int col = charPos % FONT_NUM_COLS;</span><br><span class="line">            cropRect[0] = col * font.char_width;  // Left of column</span><br><span class="line">            cropRect[1] = row * font.char_height * 2; // Top of row</span><br><span class="line">            // Move down to bottom of regular (one char_heigh) or bold (two char_heigh) line</span><br><span class="line">            cropRect[1] += bold ? 2 * font.char_height : font.char_height;</span><br><span class="line">            glTexParameteriv(GL_TEXTURE_2D, GL_TEXTURE_CROP_RECT_OES, cropRect);</span><br><span class="line"></span><br><span class="line">            glDrawTexiOES(*x, *y, 0, font.char_width, font.char_height);</span><br><span class="line"></span><br><span class="line">            *x += font.char_width;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        glDisable(GL_BLEND);  // Return to the animation&#x27;s default behaviour</span><br><span class="line">        glBindTexture(GL_TEXTURE_2D, 0);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>首先在BootAnimation.h中声明Font:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Font        mClockFont;</span><br></pre></td></tr></table></figure>
<p>然后修改<code>BootAnimation.cpp</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">bool BootAnimation::android() &#123;</span><br><span class="line">        ALOGD(&quot;%sAnimationShownTiming start time: %&quot;</span><br><span class="line">        PRId64</span><br><span class="line">        &quot;ms&quot;, mShuttingDown ? &quot;Shutdown&quot; : &quot;Boot&quot;,</span><br><span class="line">                elapsedRealtime());</span><br><span class="line">        initTexture(&amp;mAndroid[0], mAssets, &quot;images/android-logo-mask.png&quot;);</span><br><span class="line">        initTexture(&amp;mAndroid[1], mAssets, &quot;images/android-logo-shine.png&quot;);</span><br><span class="line"></span><br><span class="line">        mCallbacks-&gt;init(&#123;&#125;);</span><br><span class="line">        /**</span><br><span class="line">         * add by tang.haoyu</span><br><span class="line">         */</span><br><span class="line">        bool hasInitFont = false;</span><br><span class="line">        if (initFont(&amp;mClockFont, CLOCK_FONT_ASSET) == NO_ERROR) &#123;</span><br><span class="line">            hasInitFont = true;</span><br><span class="line">            ALOGD(&quot;android init font ok, fontname = %u&quot;, mClockFont.texture.name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // clear screen</span><br><span class="line">        glShadeModel(GL_FLAT);</span><br><span class="line">        glDisable(GL_DITHER);</span><br><span class="line">        glDisable(GL_SCISSOR_TEST);</span><br><span class="line">        glClearColor(0, 0, 0, 1);</span><br><span class="line">        glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line">        eglSwapBuffers(mDisplay, mSurface);</span><br><span class="line"></span><br><span class="line">        glEnable(GL_TEXTURE_2D);</span><br><span class="line">        glTexEnvx(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_REPLACE);</span><br><span class="line"></span><br><span class="line">        const GLint xc = (mWidth - mAndroid[0].w) / 2;</span><br><span class="line">        const GLint yc = (mHeight - mAndroid[0].h) / 2;</span><br><span class="line">        /**</span><br><span class="line">         * add by tang.haoyu</span><br><span class="line">         * resize the Rect</span><br><span class="line">         */</span><br><span class="line">        const Rect updateRect(xc, yc, xc + mAndroid[0].w, yc + mAndroid[0].h * 2);</span><br><span class="line"></span><br><span class="line">        glScissor(updateRect.left, mHeight - updateRect.bottom, updateRect.width(),</span><br><span class="line">                  updateRect.height() * 2);</span><br><span class="line"></span><br><span class="line">        // Blend state</span><br><span class="line">        glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line">        glTexEnvx(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_REPLACE);</span><br><span class="line"></span><br><span class="line">        const nsecs_t startTime = systemTime();</span><br><span class="line">        do &#123;</span><br><span class="line">            nsecs_t now = systemTime();</span><br><span class="line">            double time = now - startTime;</span><br><span class="line">            float t = 4.0f * float(time / us2ns(16667)) / mAndroid[1].w;</span><br><span class="line">            GLint offset = (1 - (t - floorf(t))) * mAndroid[1].w;</span><br><span class="line">            GLint x = xc - offset;</span><br><span class="line"></span><br><span class="line">            glDisable(GL_SCISSOR_TEST);</span><br><span class="line">            glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">            glEnable(GL_SCISSOR_TEST);</span><br><span class="line">            glDisable(GL_BLEND);</span><br><span class="line">            glBindTexture(GL_TEXTURE_2D, mAndroid[1].name);</span><br><span class="line">            glDrawTexiOES(x, yc, 0, mAndroid[1].w, mAndroid[1].h);</span><br><span class="line">            glDrawTexiOES(x + mAndroid[1].w, yc, 0, mAndroid[1].w, mAndroid[1].h);</span><br><span class="line"></span><br><span class="line">            glEnable(GL_BLEND);</span><br><span class="line">            glBindTexture(GL_TEXTURE_2D, mAndroid[0].name);</span><br><span class="line">            glDrawTexiOES(xc, yc, 0, mAndroid[0].w, mAndroid[0].h);</span><br><span class="line">            /**</span><br><span class="line">             * add by tang.haoyu</span><br><span class="line">             */</span><br><span class="line">            drawClock(mClockFont, TEXT_CENTER_VALUE, yc + mAndroid[0].h);</span><br><span class="line">            EGLBoolean res = eglSwapBuffers(mDisplay, mSurface);</span><br><span class="line">            if (res == EGL_FALSE)</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            // 12fps: don&#x27;t animate too fast to preserve CPU</span><br><span class="line">            const nsecs_t sleepTime = 83333 - ns2us(systemTime() - now);</span><br><span class="line">            if (sleepTime &gt; 0)</span><br><span class="line">                usleep(sleepTime);</span><br><span class="line"></span><br><span class="line">            checkExit();</span><br><span class="line">        &#125; while (!exitPending());</span><br><span class="line"></span><br><span class="line">        glDeleteTextures(1, &amp;mAndroid[0].name);</span><br><span class="line">        glDeleteTextures(1, &amp;mAndroid[1].name);</span><br><span class="line">        /**</span><br><span class="line">         * add by tang.haoyu</span><br><span class="line">         * close texture when exit.</span><br><span class="line">         */</span><br><span class="line">        if (hasInitFont) &#123;</span><br><span class="line">            glDeleteTextures(1, &amp;mClockFont.texture.name);</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="开机动画源码分析zip包的运行原理">开机动画源码分析zip包的运行原理</h4>
<p>首先我们可以看<code>/home/tanghaoyu/aosp/android-8.1.0_r1/frameworks/base/cmds/bootanimation</code>路径下的<code>FORMAT.md</code>文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">desc.txt - a text file</span><br><span class="line">part0  \</span><br><span class="line">part1   \  directories full of PNG frames</span><br><span class="line">...     /</span><br><span class="line">partN  /</span><br></pre></td></tr></table></figure>
<p>desc.txt文件格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WIDTH HEIGHT FPS</span><br></pre></td></tr></table></figure>
<p>后面的内容如下：</p>
<pre><code>TYPE COUNT PAUSE PATH [#RGBHEX CLOCK]
</code></pre>
<ul>
<li><strong>TYPE:</strong> a single char indicating what type of animation segment this is:
<ul>
<li><code>p</code> – 当系统启动会被打断</li>
<li><code>c</code> – 无论如何都不会被打断</li>
</ul>
</li>
<li><strong>COUNT:</strong> 展示多少次动画，如果是0则一直循环</li>
<li><strong>PAUSE:</strong> 在part执行完停留几帧</li>
<li><strong>PATH:</strong> 可以找到帧的文件夹 (e.g. <code>part0</code>)</li>
<li><strong>RGBHEX:</strong> <em>(OPTIONAL)</em> a background color, specified as <code>#RRGGBB</code></li>
<li><strong>CLOCK:</strong> <em>(OPTIONAL)</em> the y-coordinate at which to draw the current time (for watches)</li>
</ul>
<p>如果在<code>/home/tanghaoyu/aosp/android-8.1.0_r1/frameworks/base/cmds/bootanimation</code>路径下有<code>bootanimation</code>文件。则会调用下面的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">bool BootAnimation::movie() &#123;</span><br><span class="line">		// 加载动画</span><br><span class="line">        Animation *animation = loadAnimation(mZipFileName);</span><br><span class="line">        if (animation == NULL)</span><br><span class="line">            return false;</span><br><span class="line"></span><br><span class="line">        bool anyPartHasClock = false;</span><br><span class="line">        for (size_t i = 0; i &lt; animation-&gt;parts.size(); i++) &#123;</span><br><span class="line">            if (validClock(animation-&gt;parts[i])) &#123;</span><br><span class="line">                anyPartHasClock = true;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!anyPartHasClock) &#123;</span><br><span class="line">            mClockEnabled = false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Check if npot textures are supported</span><br><span class="line">        mUseNpotTextures = false;</span><br><span class="line">        String8 gl_extensions;</span><br><span class="line">        const char *exts = reinterpret_cast&lt;const char *&gt;(glGetString(GL_EXTENSIONS));</span><br><span class="line">        if (!exts) &#123;</span><br><span class="line">            glGetError();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            gl_extensions.setTo(exts);</span><br><span class="line">            if ((gl_extensions.find(&quot;GL_ARB_texture_non_power_of_two&quot;) != -1) ||</span><br><span class="line">                (gl_extensions.find(&quot;GL_OES_texture_npot&quot;) != -1)) &#123;</span><br><span class="line">                mUseNpotTextures = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Blend required to draw time on top of animation frames.</span><br><span class="line">        glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line">        glShadeModel(GL_FLAT);</span><br><span class="line">        glDisable(GL_DITHER);</span><br><span class="line">        glDisable(GL_SCISSOR_TEST);</span><br><span class="line">        glDisable(GL_BLEND);</span><br><span class="line"></span><br><span class="line">        glBindTexture(GL_TEXTURE_2D, 0);</span><br><span class="line">        glEnable(GL_TEXTURE_2D);</span><br><span class="line">        glTexEnvx(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_REPLACE);</span><br><span class="line">        glTexParameterx(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);</span><br><span class="line">        glTexParameterx(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);</span><br><span class="line">        glTexParameterx(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</span><br><span class="line">        glTexParameterx(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span><br><span class="line"></span><br><span class="line">        bool clockFontInitialized = false;</span><br><span class="line">        if (mClockEnabled) &#123;</span><br><span class="line">            clockFontInitialized =</span><br><span class="line">                    (initFont(&amp;animation-&gt;clockFont, CLOCK_FONT_ASSET) == NO_ERROR);</span><br><span class="line">            mClockEnabled = clockFontInitialized;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (mClockEnabled &amp;&amp; !updateIsTimeAccurate()) &#123;</span><br><span class="line">            mTimeCheckThread = new TimeCheckThread(this);</span><br><span class="line">            mTimeCheckThread-&gt;run(&quot;BootAnimation::TimeCheckThread&quot;, PRIORITY_NORMAL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        playAnimation(*animation);</span><br><span class="line"></span><br><span class="line">        if (mTimeCheckThread != nullptr) &#123;</span><br><span class="line">            mTimeCheckThread-&gt;requestExit();</span><br><span class="line">            mTimeCheckThread = nullptr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        releaseAnimation(animation);</span><br><span class="line"></span><br><span class="line">        if (clockFontInitialized) &#123;</span><br><span class="line">            glDeleteTextures(1, &amp;animation-&gt;clockFont.texture.name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>加载动画：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">BootAnimation::Animation *BootAnimation::loadAnimation(const String8 &amp;fn) &#123;</span><br><span class="line">        if (mLoadedFiles.indexOf(fn) &gt;= 0) &#123;</span><br><span class="line">            ALOGE(&quot;File \&quot;%s\&quot; is already loaded. Cyclic ref is not allowed&quot;,</span><br><span class="line">                  fn.string());</span><br><span class="line">            return NULL;</span><br><span class="line">        &#125;</span><br><span class="line">        ZipFileRO *zip = ZipFileRO::open(fn);</span><br><span class="line">        if (zip == NULL) &#123;</span><br><span class="line">            ALOGE(&quot;Failed to open animation zip \&quot;%s\&quot;: %s&quot;,</span><br><span class="line">                  fn.string(), strerror(errno));</span><br><span class="line">            return NULL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Animation *animation = new Animation;</span><br><span class="line">        animation-&gt;fileName = fn;</span><br><span class="line">        animation-&gt;zip = zip;</span><br><span class="line">        animation-&gt;clockFont.map = nullptr;</span><br><span class="line">        mLoadedFiles.add(animation-&gt;fileName);</span><br><span class="line"></span><br><span class="line">        parseAnimationDesc(*animation);</span><br><span class="line">        if (!preloadZip(*animation)) &#123;</span><br><span class="line">            return NULL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        mLoadedFiles.remove(fn);</span><br><span class="line">        return animation;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>解析描述文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">bool BootAnimation::parseAnimationDesc(Animation &amp;animation) &#123;</span><br><span class="line">        String8 desString;</span><br><span class="line"></span><br><span class="line">        if (!readFile(animation.zip, &quot;desc.txt&quot;, desString)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        char const *s = desString.string();</span><br><span class="line"></span><br><span class="line">        // Parse the description file</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            const char *endl = strstr(s, &quot;\n&quot;);</span><br><span class="line">            if (endl == NULL) break;</span><br><span class="line">            String8 line(s, endl - s);</span><br><span class="line">            const char *l = line.string();</span><br><span class="line">            int fps = 0;</span><br><span class="line">            int width = 0;</span><br><span class="line">            int height = 0;</span><br><span class="line">            int count = 0;</span><br><span class="line">            int pause = 0;</span><br><span class="line">            char path[ANIM_ENTRY_NAME_MAX];</span><br><span class="line">            char color[7] = &quot;000000&quot;; // default to black if unspecified</span><br><span class="line">            char clockPos1[TEXT_POS_LEN_MAX + 1] = &quot;&quot;;</span><br><span class="line">            char clockPos2[TEXT_POS_LEN_MAX + 1] = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">            char pathType;</span><br><span class="line">            if (sscanf(l, &quot;%d %d %d&quot;, &amp;width, &amp;height, &amp;fps) == 3) &#123;</span><br><span class="line">                // ALOGD(&quot;&gt; w=%d, h=%d, fps=%d&quot;, width, height, fps);</span><br><span class="line">                animation.width = width;</span><br><span class="line">                animation.height = height;</span><br><span class="line">                animation.fps = fps;</span><br><span class="line">            &#125; else if (sscanf(l, &quot; %c %d %d %s #%6s %16s %16s&quot;,</span><br><span class="line">                              &amp;pathType, &amp;count, &amp;pause, path, color, clockPos1, clockPos2) &gt;= 4) &#123;</span><br><span class="line">                //ALOGD(&quot;&gt; type=%c, count=%d, pause=%d, path=%s, color=%s, clockPos1=%s, clockPos2=%s&quot;,</span><br><span class="line">                //    pathType, count, pause, path, color, clockPos1, clockPos2);</span><br><span class="line">                Animation::Part part;</span><br><span class="line">                part.playUntilComplete = pathType == &#x27;c&#x27;;</span><br><span class="line">                part.count = count;</span><br><span class="line">                part.pause = pause;</span><br><span class="line">                part.path = path;</span><br><span class="line">                part.audioData = NULL;</span><br><span class="line">                part.animation = NULL;</span><br><span class="line">                if (!parseColor(color, part.backgroundColor)) &#123;</span><br><span class="line">                    ALOGE(&quot;&gt; invalid color &#x27;#%s&#x27;&quot;, color);</span><br><span class="line">                    part.backgroundColor[0] = 0.0f;</span><br><span class="line">                    part.backgroundColor[1] = 0.0f;</span><br><span class="line">                    part.backgroundColor[2] = 0.0f;</span><br><span class="line">                &#125;</span><br><span class="line">                parsePosition(clockPos1, clockPos2, &amp;part.clockPosX, &amp;part.clockPosY);</span><br><span class="line">                animation.parts.add(part);</span><br><span class="line">            &#125; else if (strcmp(l, &quot;$SYSTEM&quot;) == 0) &#123;</span><br><span class="line">                // ALOGD(&quot;&gt; SYSTEM&quot;);</span><br><span class="line">                Animation::Part part;</span><br><span class="line">                part.playUntilComplete = false;</span><br><span class="line">                part.count = 1;</span><br><span class="line">                part.pause = 0;</span><br><span class="line">                part.audioData = NULL;</span><br><span class="line">                part.animation = loadAnimation(String8(SYSTEM_BOOTANIMATION_FILE));</span><br><span class="line">                if (part.animation != NULL)</span><br><span class="line">                    animation.parts.add(part);</span><br><span class="line">            &#125;</span><br><span class="line">            s = ++endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在解析完后，就会preload zip文件夹：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">bool BootAnimation::preloadZip(Animation &amp;animation) &#123;</span><br><span class="line">    // read all the data structures</span><br><span class="line">    const size_t pcount = animation.parts.size();</span><br><span class="line">    void *cookie = NULL;</span><br><span class="line">    ZipFileRO *zip = animation.zip;</span><br><span class="line">    if (!zip-&gt;startIteration(&amp;cookie)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ZipEntryRO entry;</span><br><span class="line">    char name[ANIM_ENTRY_NAME_MAX];</span><br><span class="line">    while ((entry = zip-&gt;nextEntry(cookie)) != NULL) &#123;</span><br><span class="line">        const int foundEntryName = zip-&gt;getEntryFileName(entry, name, ANIM_ENTRY_NAME_MAX);</span><br><span class="line">        if (foundEntryName &gt; ANIM_ENTRY_NAME_MAX || foundEntryName == -1) &#123;</span><br><span class="line">            ALOGE(&quot;Error fetching entry file name&quot;);</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        const String8 entryName(name);</span><br><span class="line">        const String8 path(entryName.getPathDir());</span><br><span class="line">        const String8 leaf(entryName.getPathLeaf());</span><br><span class="line">        if (leaf.size() &gt; 0) &#123;</span><br><span class="line">            if (entryName == CLOCK_FONT_ZIP_NAME) &#123;</span><br><span class="line">                FileMap *map = zip-&gt;createEntryFileMap(entry);</span><br><span class="line">                if (map) &#123;</span><br><span class="line">                    animation.clockFont.map = map;</span><br><span class="line">                &#125;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            for (size_t j = 0; j &lt; pcount; j++) &#123;</span><br><span class="line">                if (path == animation.parts[j].path) &#123;</span><br><span class="line">                    uint16_t method;</span><br><span class="line">                    // supports only stored png files</span><br><span class="line">                    if (zip-&gt;getEntryInfo(entry, &amp;method, NULL, NULL, NULL, NULL, NULL)) &#123;</span><br><span class="line">                        if (method == ZipFileRO::kCompressStored) &#123;</span><br><span class="line">                            FileMap *map = zip-&gt;createEntryFileMap(entry);</span><br><span class="line">                            if (map) &#123;</span><br><span class="line">                                Animation::Part &amp;part(animation.parts.editItemAt(j));</span><br><span class="line">                                if (leaf == &quot;audio.wav&quot;) &#123;</span><br><span class="line">                                    // a part may have at most one audio file</span><br><span class="line">                                    part.audioData = (uint8_t *) map-&gt;getDataPtr();</span><br><span class="line">                                    part.audioLength = map-&gt;getDataLength();</span><br><span class="line">                                &#125; else if (leaf == &quot;trim.txt&quot;) &#123;</span><br><span class="line">                                    part.trimData.setTo((char const *) map-&gt;getDataPtr(),</span><br><span class="line">                                                        map-&gt;getDataLength());</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    Animation::Frame frame;</span><br><span class="line">                                    frame.name = leaf;</span><br><span class="line">                                    frame.map = map;</span><br><span class="line">                                    frame.trimWidth = animation.width;</span><br><span class="line">                                    frame.trimHeight = animation.height;</span><br><span class="line">                                    frame.trimX = 0;</span><br><span class="line">                                    frame.trimY = 0;</span><br><span class="line">                                    part.frames.add(frame);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            ALOGE(&quot;bootanimation.zip is compressed; must be only stored&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If there is trimData present, override the positioning defaults.</span><br><span class="line">    for (Animation::Part &amp;part: animation.parts) &#123;</span><br><span class="line">        const char *trimDataStr = part.trimData.string();</span><br><span class="line">        for (size_t frameIdx = 0; frameIdx &lt; part.frames.size(); frameIdx++) &#123;</span><br><span class="line">            const char *endl = strstr(trimDataStr, &quot;\n&quot;);</span><br><span class="line">            // No more trimData for this part.</span><br><span class="line">            if (endl == NULL) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            String8 line(trimDataStr, endl - trimDataStr);</span><br><span class="line">            const char *lineStr = line.string();</span><br><span class="line">            trimDataStr = ++endl;</span><br><span class="line">            int width = 0, height = 0, x = 0, y = 0;</span><br><span class="line">            if (sscanf(lineStr, &quot;%dx%d+%d+%d&quot;, &amp;width, &amp;height, &amp;x, &amp;y) == 4) &#123;</span><br><span class="line">                Animation::Frame &amp;frame(part.frames.editItemAt(frameIdx));</span><br><span class="line">                frame.trimWidth = width;</span><br><span class="line">                frame.trimHeight = height;</span><br><span class="line">                frame.trimX = x;</span><br><span class="line">                frame.trimY = y;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                ALOGE(&quot;Error parsing trim.txt, line: %s&quot;, lineStr);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mCallbacks-&gt;init(animation.parts);</span><br><span class="line"></span><br><span class="line">    zip-&gt;endIteration(cookie);</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="实战制作bootanimation">实战制作bootanimation</h4>
<p><img src="E:%5Ccode%5Cdocs%5Cblogdocs%5C%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%5Cassets%5Czip-make-step.png" alt=""></p>
<p>将你的part1, part2, … , desc.txt文件放到一个文件夹下，使用下面的命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r -X -Z store bootanimation part*/* desc.txt</span><br></pre></td></tr></table></figure>
<p>然后将制作的bootanimation.zip集成到<code>/system/media</code>目录下，这需要在Android.mk进行cp操作。</p>
<p>在<code>LOCAL_CFLAGS += $&#123;bootanimation_CommonCFlags&#125;</code>下面添加下面的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(shell cp $(LOCAL_PATH)/bootanimation.zip $(ANDROID_PRODUCT_OUT)/system/media/bootanimation-encrypted.zip)</span><br></pre></td></tr></table></figure>
<h3 id="Android-native层thread实现方案">Android native层thread实现方案</h3>
<h4 id="沿用linux上的posix线程方案">沿用linux上的posix线程方案</h4>
<p>为什么要有线程：</p>
<p>一个进程可以有多个线程，这个进程本身也叫做线程，只不过是主线程。通常主线程分配任务给子线程做。程序设计时候就可以某一时刻不止做一件事，每一个线程处理各自独立的任务。</p>
<ul>
<li>多个线程自动可以访问相同的存储地址空间和文件描述符。</li>
<li>每个线程都包含有表示执行环境所必须的信息，其中包括线程ID、一组寄存器、栈、调度优先级和策略、信号屏蔽字、errno变量及线程私有数据。一个进程所有信息对该进程所有线程共享，包括可执行代码、程序的全局内存和堆内存、栈以及文件描述符。</li>
</ul>
<p>线程ID：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pthread_t</span><span class="comment">//用于表示线程ID数据结构</span></span><br><span class="line"></span><br><span class="line">pthread_equal (<span class="keyword">pthread_t</span> __thread1, <span class="keyword">pthread_t</span> __thread2);<span class="comment">//用于比较线程ID</span></span><br><span class="line"><span class="function"><span class="keyword">pthread_t</span> <span class="title">pthread_self</span> <span class="params">(<span class="keyword">void</span>)</span></span>;<span class="comment">//用户返回线程ID</span></span><br></pre></td></tr></table></figure>
<p>线程创建</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pthread_create()</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">__newthread:函数成功返回将ID存储在此变量中。</span></span><br><span class="line"><span class="comment">__attr:定制线程属性。</span></span><br><span class="line"><span class="comment">__start_routine:函数指针。</span></span><br><span class="line"><span class="comment">__arg:传递给函数的参数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_create</span> <span class="params">(<span class="keyword">pthread_t</span> *__restrict__newthread,</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *__restrict__attr,</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="keyword">void</span> *(*__start_routine) (<span class="keyword">void</span> *),</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="keyword">void</span> *__restrict__arg)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>线程终止</p>
<p>如果进程中的任意线程调用了exit、_Exit或者exit，那么整个进程就会终止。并且如果信号的默认动作是终止进程，那么收到该信号的进程也会终止。<br>
单个线程可以通过3种方式退出，因此可以在不终止整个进程的情况下，停止它的控制流。</p>
<ol>
<li>线程可以简单地从启动例程中返回，返回值是线程的退出码。</li>
<li>线程可以被同一进程中的其他线程取消。</li>
<li>线程调用pthead_exit。</li>
</ol>
<p>下面，我们写一个可以在Android运行的线程示例：</p>
<p>首先，我们需要写一个mk文件：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"> </span><br><span class="line">LOCAL_SRC_FILES := MyThread.cpp \</span><br><span class="line">	Main.cpp \</span><br><span class="line">	</span><br><span class="line">   </span><br><span class="line">LOCAL_SHARED_LIBRARIES :=libandroid_runtime \</span><br><span class="line">	libcutils \</span><br><span class="line">	libutils \</span><br><span class="line">        liblog </span><br><span class="line">	</span><br><span class="line">LOCAL_MODULE := android_thread</span><br><span class="line"> </span><br><span class="line">	</span><br><span class="line">LOCAL_PRELINK_MODULE := false</span><br><span class="line"> </span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_EXECUTABLE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"> </span><br><span class="line">LOCAL_SRC_FILES := thread_posix.c </span><br><span class="line">	</span><br><span class="line">LOCAL_MODULE := linux_thread</span><br><span class="line">LOCAL_SHARED_LIBRARIES :=liblog  </span><br><span class="line">	</span><br><span class="line">LOCAL_PRELINK_MODULE := false</span><br><span class="line"> </span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_EXECUTABLE)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面代码的含义：</p>
<p>这段代码是Android.mk文件的一部分，用于构建Android Native C/C++ 库或应用程序。这是Android NDK（Native Development Kit）中的构建系统所使用的文件格式。每个模块定义了一个目标，通常是一个静态库、动态库或可执行文件。下面逐行解释这段代码：</p>
<ol>
<li>
<p>LOCAL_SRC_FILES := thread_posix.c</p>
<p>这行指定了本地模块（本例中是一个可执行文件）的源代码文件。thread_posix.c是C语言的源代码文件，它会被编译并链接到最终的目标中。</p>
</li>
<li>
<p>LOCAL_MODULE := linux_thread</p>
<p>这里定义了模块的名称为linux_thread。在构建过程中，这个名称将被用来生成目标的文件名，比如liblinux_thread.so或linux_thread（对于可执行文件）。</p>
</li>
<li>
<p>LOCAL_SHARED_LIBRARIES := liblog</p>
<p>这行声明了模块在链接时需要的共享库。在这个例子中，模块依赖于liblog，即Android的日志系统库。这确保在生成最终可执行文件时，liblog.so会被链接进来。</p>
</li>
<li>
<p>LOCAL_PRELINK_MODULE := false</p>
<p>这个变量一般用在库的构建中，设置为false意味着在安装之前不需要预链接这个模块。对于可执行文件，通常不需要预链接，因此设置为false是标准做法。</p>
</li>
<li>
<p>include $(BUILD_EXECUTABLE)</p>
<p>最后这一行包含了Android NDK构建系统提供的宏定义，$(BUILD_EXECUTABLE)是一个宏，它会根据前面定义的变量（如LOCAL_MODULE和LOCAL_SRC_FILES）来生成构建可执行文件所需的适当命令。这行指令告诉NDK我们正在构建一个可执行文件，而不是库。<br>
当整个Android.mk文件被mm（make modules）或make命令处理时，这些指令会被解释并执行，从而编译源代码，解决依赖性，链接所需的库，并生成最终的可执行文件。</p>
</li>
</ol>
<p>创建线程代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Log.h&gt;</span></span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> *<span class="title">thread_posix_function</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">  (<span class="keyword">void</span>*)arg;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> ( i=<span class="number">0</span>; i&lt;<span class="number">30</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello thread i = %d\n&quot;</span>,i);</span><br><span class="line">    ALOGD(<span class="string">&quot;hello thread i = %d\n&quot;</span>,i);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">pthread_t</span> mythread;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> ( pthread_create( &amp;mythread, <span class="literal">NULL</span>, thread_posix_function, <span class="literal">NULL</span>) ) &#123;</span><br><span class="line">    ALOGD(<span class="string">&quot;error creating thread.&quot;</span>);</span><br><span class="line">    <span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( pthread_join ( mythread, <span class="literal">NULL</span> ) ) &#123;</span><br><span class="line">    ALOGD(<span class="string">&quot;error joining thread.&quot;</span>);</span><br><span class="line">    <span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  ALOGD(<span class="string">&quot;hello thread has run end exit\n&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码的含义如下：</p>
<p>这段代码是一个简单的C程序，展示了如何使用POSIX线程库（pthread.h）在Linux或类Unix系统上创建和管理线程。同时，它还使用了Android日志系统（通过utils/Log.h头文件）来输出日志信息。下面是代码的详细解释：</p>
<ol>
<li>头文件包含:
<ul>
<li>&lt;pthread.h&gt;: 包含多线程编程所需的函数声明，如线程创建、销毁、同步等。</li>
<li>&lt;stdlib.h&gt; 和 &lt;stdio.h&gt;: 分别用于内存管理和标准输入输出功能，如malloc, free, printf等</li>
<li>&lt;utils/Log.h&gt;: Android特有的日志工具头文件，提供了不同级别日志输出的函数，如ALOGD（用于输出调试信息）。</li>
</ul>
</li>
<li>线程函数：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_posix_function</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    (<span class="keyword">void</span>*)arg; <span class="comment">// 忽略传入的参数</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello thread i = %d\n&quot;</span>, i);</span><br><span class="line">        ALOGD(<span class="string">&quot;hello thread i = %d\n&quot;</span>, i);</span><br><span class="line">        sleep(<span class="number">1</span>); <span class="comment">// 线程每运行一次循环就暂停1秒</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>; <span class="comment">// 线程结束，返回空指针</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数是新线程执行的任务，它打印出从0到29的数字，并在每次打印后暂停1秒。这里使用了标准输出printf以及Android日志系统ALOGD来输出信息。</p>
<ol start="3">
<li>主函数:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> mythread; <span class="comment">// 定义线程标识符</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建线程</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_create(&amp;mythread, <span class="literal">NULL</span>, thread_posix_function, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        ALOGD(<span class="string">&quot;error creating thread.&quot;</span>);</span><br><span class="line">        <span class="built_in">abort</span>(); <span class="comment">// 如果创建失败，则输出错误日志并终止程序</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待线程结束</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_join(mythread, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        ALOGD(<span class="string">&quot;error joining thread.&quot;</span>);</span><br><span class="line">        <span class="built_in">abort</span>(); <span class="comment">// 如果等待失败，则输出错误日志并终止程序</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">&quot;hello thread has run end exit\n&quot;</span>); <span class="comment">// 线程执行完毕，主程序退出前输出日志</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">// 正常退出程序</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在main函数中，首先声明了一个pthread_t类型的变量mythread来存储新线程的标识符。然后调用pthread_create函数创建一个新的线程，该线程将执行thread_posix_function函数。如果线程创建成功，程序会调用pthread_join等待这个线程结束。最后，程序正常退出，输出一条日志表示线程已执行完毕并退出。</p>
<p>然后，我们在根目录下执行<code>make linux_thread</code>。</p>
<h4 id="android在native层面封装的thread类">android在native层面封装的thread类</h4>
<p>Android native的Thread类是Android提供的一个基础类，源码路径：</p>
<p><code>system\core\libutils\include\utils\Thread.h</code></p>
<p><code>system\core\libutils\Thread.cpp</code></p>
<p>该类提供的基础功能涵盖了线程的声明周期：创建，运行，销毁。主要成员函数如下：</p>
<ol>
<li>本身继承于RefBase，所以具有相应的一些特性</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Invoke after creation of initial strong pointer/reference</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onFirstRef</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>执行线程创建并启动通过run方法（和Java有些差异）</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">run</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">int32_t</span> priority, <span class="keyword">size_t</span> stack)</span></span>;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>循环执行方法</li>
</ol>
<p>创建完成后，开始执行_threadLoop()函数，该函数主要通过调用threadLoop函数，因此基类必须要实现threadLoop函数，作为线程执行函数，它是有返回值的方法，而且_threadLoop会根据返回值确定是否继续循环执行的方法。</p>
<ol start="4">
<li>线程请求退出的方法</li>
</ol>
<p>线程销毁，子类最好通过实现requestExit()函数，首先调用Thread类的requestExit()函数，将线程状态mExitPending置为true，然后中断threadLoop。</p>
<h4 id="实战">实战</h4>
<p>那么我们应该如何使用Android给我们封装的线程类呢，可以看下面的代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">&quot;MyThread&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MyThread.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> android &#123;</span><br><span class="line"> </span><br><span class="line">	MyThread::<span class="built_in">MyThread</span>() :</span><br><span class="line">			<span class="built_in">Thread</span>(<span class="literal">false</span>) &#123;</span><br><span class="line">		<span class="built_in">ALOGD</span>(<span class="string">&quot;MyThread&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	  </span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">MyThread::threadLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="built_in">ALOGD</span>(<span class="string">&quot;threadLoop hasRunCount = %d&quot;</span>,hasRunCount);</span><br><span class="line">		hasRunCount++;</span><br><span class="line">		<span class="keyword">if</span> (hasRunCount == <span class="number">10</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;		</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">MyThread::onFirstRef</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="built_in">ALOGD</span>(<span class="string">&quot;onFirstRef&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">status_t</span> <span class="title">MyThread::readyToRun</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="built_in">ALOGD</span>(<span class="string">&quot;readyToRun&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">MyThread::requestExit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="built_in">ALOGD</span>(<span class="string">&quot;requestExit&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>#define LOG_TAG “MyThread”：定义了一个宏LOG_TAG，用于在日志输出中标识当前模块的名称。</p>
</li>
<li>
<p>#include &lt;utils/Log.h&gt;：引入了Android的Log头文件，提供方便的日志输出功能。</p>
</li>
<li>
<p>#include “MyThread.h”：假设这是MyThread类的实现，这里包含MyThread的头文件。</p>
</li>
<li>
<p>namespace android { … }：在android命名空间中定义MyThread类。</p>
</li>
<li>
<p>MyThread::MyThread() : Thread(false) { … }：MyThread的构造函数，传入false参数给基类Thread的构造函数，表示不创建一个自动启动的线程。</p>
<ul>
<li>ALOGD(“MyThread”);：输出调试日志，标记构造函数的执行。</li>
</ul>
</li>
<li>
<p>bool MyThread::threadLoop() { … }：重写了Thread类的threadLoop方法，这是线程的主要运行逻辑。</p>
<ul>
<li>输出当前hasRunCount的值。</li>
<li>将hasRunCount自增1。</li>
<li>当hasRunCount达到10时，返回false，表示线程应退出；否则返回true，继续运行。</li>
</ul>
</li>
<li>
<p>void MyThread::onFirstRef() { … }：onFirstRef方法，当线程首次获得引用时调用。在这里输出调试日志。</p>
</li>
<li>
<p>status_t MyThread::readyToRun() { … }：重写了Thread类的readyToRun方法，表示线程准备就绪。返回0表示成功。</p>
</li>
<li>
<p>void MyThread::requestExit() { … }：重写了Thread类的requestExit方法，用于请求线程退出。在这个实现中，仅输出调试日志，实际的退出逻辑可能由基类Thread处理。</p>
<p>这个MyThread类用于创建一个可控制运行次数的线程，当threadLoop被调用10次后，线程会自动退出。</p>
</li>
</ol>
<h3 id="Zygote启动流程分析">Zygote启动流程分析</h3>
<h4 id="Zygote简单介绍">Zygote简单介绍</h4>
<p>在Android系统中，普通应用程序进程以及系统的服务system_server进程都是由Zygote进程来fork的，也叫做孵化器，它通过linux中的fork形式创建应用程序进程和system_server。由于Zygote进程在启动的时候会创建java虚拟机环境，因此通过fork而创建的应用程序进程或者system_server进程可以在内部获得java虚拟机环境，不需要再为每一个进程创建java虚拟机环境</p>
<h4 id="Zygote启动脚本">Zygote启动脚本</h4>
<p><code>init.rc</code>是以<code>import</code>方式来引入各个模块的rc的，包括前面讲的bootanimation，surfaceflinger等也是，当然zygote也是一样</p>
<p>zygote的init.rc的路径如下：</p>
<blockquote>
<p>system/core/rootdir/init.zygote32.rc</p>
</blockquote>
<p>这里有多个zygote.rc，那是因为android系统支持64位系统和32位的原因</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server</span><br><span class="line">    class main</span><br><span class="line">    priority -20</span><br><span class="line">    user root</span><br><span class="line">    group root readproc</span><br><span class="line">    socket zygote stream 660 root system</span><br><span class="line">    onrestart write /sys/android_power/request_state wake</span><br><span class="line">    onrestart write /sys/power/state on</span><br><span class="line">    onrestart restart audioserver</span><br><span class="line">    onrestart restart cameraserver</span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart netd</span><br><span class="line">    onrestart restart wificond</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks</span><br></pre></td></tr></table></figure>
<p>我们grep app_process可以定位到zygote的代码在<code>frameworks/base/cmds/app_process</code>下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Main entry of app process.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Starts the interpreted runtime, then starts up the application.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">&quot;appproc&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;binder/IPCThreadState.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hwbinder/IPCThreadState.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/properties.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/trace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android_runtime/AndroidRuntime.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;private/android_filesystem_config.h&gt;</span>  <span class="comment">// for AID_SYSTEM</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> android &#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse runtime arguments.  Stop at first unrecognized option.</span></span><br><span class="line">    <span class="keyword">bool</span> zygote = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> startSystemServer = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> application = <span class="literal">false</span>;</span><br><span class="line">    String8 niceName;</span><br><span class="line">    String8 className;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        <span class="comment">// 调用AndroidRuntime.start()方法</span></span><br><span class="line">        runtime.<span class="built_in">start</span>(<span class="string">&quot;com.android.internal.os.ZygoteInit&quot;</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        runtime.<span class="built_in">start</span>(<span class="string">&quot;com.android.internal.os.RuntimeInit&quot;</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Error: no class name or --zygote supplied.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">app_usage</span>();</span><br><span class="line">        <span class="built_in">LOG_ALWAYS_FATAL</span>(<span class="string">&quot;app_process: no class name or --zygote supplied.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到在<code>app_main</code>中，做了下面几件事：</p>
<ol>
<li>初始化AppRuntime，其实就是AndroidRuntime(ART)</li>
<li>设置zygote模式</li>
<li>将参数传递给ZygoteInit.main()方法</li>
<li>启动ZygoteInit。这里的ZygoteInit就是zygote进程的启动类。</li>
</ol>
<p>AndroidRuntime位于</p>
<p><code>frameworks/base/core/jni/AndroidRuntime.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start the Android runtime.  This involves starting the virtual machine and calling the &quot;static void main(String[] args)&quot; method in the class named by &quot;className&quot;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Passes the main function two arguments, the class name and the specified</span></span><br><span class="line"><span class="comment"> * options string.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AndroidRuntime::start</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    jni_invocation.<span class="built_in">Init</span>(<span class="literal">NULL</span>);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="comment">//注释1:启动虚拟机</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">startVm</span>(&amp;mJavaVM, &amp;env, zygote, primary_zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">onVmCreated</span>(env);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注释2:注册安卓功能(JNI)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">startReg</span>(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;Unable to register all android natives\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    strArray = env-&gt;<span class="built_in">NewObjectArray</span>(options.<span class="built_in">size</span>() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 启动虚拟机。 该线程成为VM的主线程，直到VM退出才会返回。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">char</span>* slashClassName = <span class="built_in">toSlashClassName</span>(className != <span class="literal">NULL</span> ? className : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    jclass startClass = env-&gt;<span class="built_in">FindClass</span>(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        jmethodID startMeth = env-&gt;<span class="built_in">GetStaticMethodID</span>(startClass, <span class="string">&quot;main&quot;</span>,</span><br><span class="line">            <span class="string">&quot;([Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//注释3</span></span><br><span class="line">            env-&gt;<span class="built_in">CallStaticVoidMethod</span>(startClass, startMeth, strArray);</span><br><span class="line">            <span class="keyword">if</span> (env-&gt;<span class="built_in">ExceptionCheck</span>())</span><br><span class="line">                <span class="built_in">threadExitUncaughtException</span>(env);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面的代码主要干了下面几件事：</p>
<p>注释1.	启动虚拟机</p>
<p>注释2.	注册安卓功能</p>
<p>注释3.	使用JNI调用ZygoteInit的main方法，这里的ZygoteInit是class文件，也就是从这里进入Java</p>
<p>可以发现，上面的代码主要是初始化了JNI功能并启动了JVM虚拟机，通过反射的方式去启动 ZygoteInit.java 的 main 方法，并将 args 参数（包含了是否启动 SystemServer 的参数）传递过去。而 JVM 虚拟机进程就是<code> com.android.internal.os.ZygoteInit</code>，而 ZygoteInit 进程位于 <code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java </code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">路径：/frameworks/base/core/java/com/android/internal/os/ZygoteInit.<span class="function">java</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">        ZygoteServer zygoteServer = <span class="keyword">new</span> ZygoteServer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mark zygote start. This ensures that thread creation will throw</span></span><br><span class="line">        <span class="comment">// an error.</span></span><br><span class="line">        ZygoteHooks.startZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Zygote goes into its own process group.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Os.setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Failed to setpgid(0,0)&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Runnable caller;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> startSystemServer = <span class="keyword">false</span>;</span><br><span class="line">            String socketName = <span class="string">&quot;zygote&quot;</span>;</span><br><span class="line">            String abiList = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">boolean</span> enableLazyPreload = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">                    startSystemServer = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;--enable-lazy-preload&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">                    enableLazyPreload = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class="line">                    abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class="line">                    socketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unknown command line argument: &quot;</span> + argv[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (abiList == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;No ABI list supplied.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Zygote作为服务端</span></span><br><span class="line">            zygoteServer.registerServerSocket(socketName);</span><br><span class="line">            <span class="comment">// In some configurations, we avoid preloading resources and classes eagerly.</span></span><br><span class="line">            <span class="comment">// In such cases, we will preload things prior to our first fork.</span></span><br><span class="line">            <span class="keyword">if</span> (!enableLazyPreload) &#123;</span><br><span class="line">                bootTimingsTraceLog.traceBegin(<span class="string">&quot;ZygotePreload&quot;</span>);</span><br><span class="line">                EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">                preload(bootTimingsTraceLog);</span><br><span class="line">                EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">                bootTimingsTraceLog.traceEnd(); <span class="comment">// ZygotePreload</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Zygote.resetNicePriority();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Do an initial gc to clean up after startup</span></span><br><span class="line">            bootTimingsTraceLog.traceBegin(<span class="string">&quot;PostZygoteInitGC&quot;</span>);</span><br><span class="line">            gcAndFinalize();</span><br><span class="line">            bootTimingsTraceLog.traceEnd(); <span class="comment">// PostZygoteInitGC</span></span><br><span class="line"></span><br><span class="line">            bootTimingsTraceLog.traceEnd(); <span class="comment">// ZygoteInit</span></span><br><span class="line">            <span class="comment">// Disable tracing so that forked processes do not inherit stale tracing tags from</span></span><br><span class="line">            <span class="comment">// Zygote.</span></span><br><span class="line">            Trace.setTracingEnabled(<span class="keyword">false</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Zygote process unmounts root storage spaces.</span></span><br><span class="line">            Zygote.nativeUnmountStorageOnInit();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set seccomp policy</span></span><br><span class="line">            Seccomp.setPolicy();</span><br><span class="line"></span><br><span class="line">            ZygoteHooks.stopZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">                Runnable r = forkSystemServer(abiList, socketName, zygoteServer);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// &#123;@code r == null&#125; in the parent (zygote) process, and &#123;@code r != null&#125; in the</span></span><br><span class="line">                <span class="comment">// child (system_server) process.</span></span><br><span class="line">                <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.i(TAG, <span class="string">&quot;Accepting command socket connections&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The select loop returns early in the child process after a fork and</span></span><br><span class="line">            <span class="comment">// loops forever in the zygote.</span></span><br><span class="line">            caller = zygoteServer.runSelectLoop(abiList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;System zygote died with exception&quot;</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            zygoteServer.closeServerSocket();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We&#x27;re in the child process and have exited the select loop. Proceed to execute the</span></span><br><span class="line">        <span class="comment">// command.</span></span><br><span class="line">        <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">            caller.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="Zygote进行fork进程">Zygote进行fork进程</h4>
<ul>
<li>实战体验linux的fork</li>
</ul>
<p>直接上代码体验fork</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main current process pid = %d \n&quot;</span>, getpid());</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child process pid == %d ppid = %d \n&quot;</span>, getpid(), getppid());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;this process current pid == %d pid = %d ppid = %d \n&quot;</span>, getpid(), pid,getppid());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们通过下面的代码编译：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc fork.c -o fork</span><br></pre></td></tr></table></figure>
<p>然后执行fork文件可以得到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main current process pid = 9599</span><br><span class="line">this process current pid == 9599 pid = 9600 ppid = 2403</span><br><span class="line">child process pid == 9600 ppid = 9599</span><br></pre></td></tr></table></figure>
<p>如果返回值为0，那么代表当前进程是子进程。返回值为非负数，代表当前进程为父进程，返回值是子进程的id号</p>
<p>在ZygoteInit.java中，我们可以找到<code>forkSystemServer</code>方法，我们进入该方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">private static Runnable forkSystemServer(String abiList, String socketName,</span><br><span class="line">            ZygoteServer zygoteServer) &#123;</span><br><span class="line">        ...</span><br><span class="line">            /* Request to fork the system server process */</span><br><span class="line">            pid = Zygote.forkSystemServer(</span><br><span class="line">                    parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">                    parsedArgs.gids,</span><br><span class="line">                    parsedArgs.debugFlags,</span><br><span class="line">                    null,</span><br><span class="line">                    parsedArgs.permittedCapabilities,</span><br><span class="line">                    parsedArgs.effectiveCapabilities);</span><br><span class="line">        &#125; catch (IllegalArgumentException ex) &#123;</span><br><span class="line">            throw new RuntimeException(ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /* For child process */</span><br><span class="line">        if (pid == 0) &#123;</span><br><span class="line">            if (hasSecondZygote(abiList)) &#123;</span><br><span class="line">                waitForSecondaryZygote(socketName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            zygoteServer.closeServerSocket();</span><br><span class="line">            return handleSystemServerProcess(parsedArgs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们进入<code>Zygote.forkSystemServer</code>方法可以找到下面的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public static int forkSystemServer(int uid, int gid, int[] gids, int debugFlags, int[][] rlimits, long permittedCapabilities, long effectiveCapabilities) &#123;</span><br><span class="line">        VM_HOOKS.preFork();</span><br><span class="line">        int pid = nativeForkSystemServer(uid, gid, gids, debugFlags, rlimits, permittedCapabilities, effectiveCapabilities);</span><br><span class="line">        VM_HOOKS.postForkCommon();</span><br><span class="line">        return pid;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以发现调用了native方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">nativeForkSystemServer</span><span class="params">(<span class="keyword">int</span> var0, <span class="keyword">int</span> var1, <span class="keyword">int</span>[] var2, <span class="keyword">int</span> var3, <span class="keyword">int</span>[][] var4, <span class="keyword">long</span> var5, <span class="keyword">long</span> var7)</span></span>;</span><br></pre></td></tr></table></figure>
<p>native方法在下面的路径<code>core/jni/com_android_internal_os_Zygote.cpp</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv* env, jclass, <span class="keyword">uid_t</span> uid, <span class="keyword">gid_t</span> gid, jintArray gids,</span></span></span><br><span class="line"><span class="params"><span class="function">        jint debug_flags, jobjectArray rlimits, jlong permittedCapabilities,</span></span></span><br><span class="line"><span class="params"><span class="function">        jlong effectiveCapabilities)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">pid_t</span> pid = <span class="built_in">ForkAndSpecializeCommon</span>(env, uid, gid, gids,</span><br><span class="line">                                      debug_flags, rlimits,</span><br><span class="line">                                      permittedCapabilities, effectiveCapabilities,</span><br><span class="line">                                      MOUNT_EXTERNAL_DEFAULT, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">true</span>, <span class="literal">NULL</span>,</span><br><span class="line">                                      <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// The zygote process checks whether the child process has died or not.</span></span><br><span class="line">      <span class="built_in">ALOGI</span>(<span class="string">&quot;System server process %d has been created&quot;</span>, pid);</span><br><span class="line">      gSystemServerPid = pid;</span><br><span class="line">      <span class="comment">// There is a slight window that the system server process has crashed</span></span><br><span class="line">      <span class="comment">// but it went unnoticed because we haven&#x27;t published its pid yet. So</span></span><br><span class="line">      <span class="comment">// we recheck here just to make sure that all is well.</span></span><br><span class="line">      <span class="keyword">int</span> status;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">waitpid</span>(pid, &amp;status, WNOHANG) == pid) &#123;</span><br><span class="line">          <span class="built_in">ALOGE</span>(<span class="string">&quot;System server process %d has died. Restarting Zygote!&quot;</span>, pid);</span><br><span class="line">          <span class="built_in">RuntimeAbort</span>(env, __LINE__, <span class="string">&quot;System server process has died. Restarting Zygote!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Assign system_server to the correct memory cgroup.</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">WriteStringToFile</span>(<span class="built_in">StringPrintf</span>(<span class="string">&quot;%d&quot;</span>, pid), <span class="string">&quot;/dev/memcg/system/tasks&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;couldn&#x27;t write %d to /dev/memcg/system/tasks&quot;</span>, pid);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>继续跟进去：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">static pid_t ForkAndSpecializeCommon(JNIEnv* env, uid_t uid, gid_t gid, jintArray javaGids,</span><br><span class="line">                                     jint debug_flags, jobjectArray javaRlimits,</span><br><span class="line">                                     jlong permittedCapabilities, jlong effectiveCapabilities,</span><br><span class="line">                                     jint mount_external,</span><br><span class="line">                                     jstring java_se_info, jstring java_se_name,</span><br><span class="line">                                     bool is_system_server, jintArray fdsToClose,</span><br><span class="line">                                     jintArray fdsToIgnore,</span><br><span class="line">                                     jstring instructionSet, jstring dataDir) &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  // 确实调用了fork</span><br><span class="line">  pid_t pid = fork();</span><br><span class="line"></span><br><span class="line">  if (pid == 0) &#123;</span><br><span class="line">    PreApplicationInit();</span><br><span class="line"></span><br><span class="line">    // Clean up any descriptors which must be closed immediately</span><br><span class="line">    DetachDescriptors(env, fdsToClose);</span><br><span class="line"></span><br><span class="line">    // Re-open all remaining open file descriptors so that they aren&#x27;t shared</span><br><span class="line">    // with the zygote across a fork.</span><br><span class="line">    if (!gOpenFdTable-&gt;ReopenOrDetach()) &#123;</span><br><span class="line">      RuntimeAbort(env, __LINE__, &quot;Unable to reopen whitelisted descriptors.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (sigprocmask(SIG_UNBLOCK, &amp;sigchld, nullptr) == -1) &#123;</span><br><span class="line">      ALOGE(&quot;sigprocmask(SIG_SETMASK, &#123; SIGCHLD &#125;) failed: %s&quot;, strerror(errno));</span><br><span class="line">      RuntimeAbort(env, __LINE__, &quot;Call to sigprocmask(SIG_UNBLOCK, &#123; SIGCHLD &#125;) failed.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Keep capabilities across UID change, unless we&#x27;re staying root.</span><br><span class="line">    if (uid != 0) &#123;</span><br><span class="line">      EnableKeepCapabilities(env);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SetInheritable(env, permittedCapabilities);</span><br><span class="line">    DropCapabilitiesBoundingSet(env);</span><br><span class="line"></span><br><span class="line">    bool use_native_bridge = !is_system_server &amp;&amp; (instructionSet != NULL)</span><br><span class="line">        &amp;&amp; android::NativeBridgeAvailable();</span><br><span class="line">    if (use_native_bridge) &#123;</span><br><span class="line">      ScopedUtfChars isa_string(env, instructionSet);</span><br><span class="line">      use_native_bridge = android::NeedsNativeBridge(isa_string.c_str());</span><br><span class="line">    &#125;</span><br><span class="line">    if (use_native_bridge &amp;&amp; dataDir == NULL) &#123;</span><br><span class="line">      // dataDir should never be null if we need to use a native bridge.</span><br><span class="line">      // In general, dataDir will never be null for normal applications. It can only happen in</span><br><span class="line">      // special cases (for isolated processes which are not associated with any app). These are</span><br><span class="line">      // launched by the framework and should not be emulated anyway.</span><br><span class="line">      use_native_bridge = false;</span><br><span class="line">      ALOGW(&quot;Native bridge will not be used because dataDir == NULL.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!MountEmulatedStorage(uid, mount_external, use_native_bridge)) &#123;</span><br><span class="line">      ALOGW(&quot;Failed to mount emulated storage: %s&quot;, strerror(errno));</span><br><span class="line">      if (errno == ENOTCONN || errno == EROFS) &#123;</span><br><span class="line">        // When device is actively encrypting, we get ENOTCONN here</span><br><span class="line">        // since FUSE was mounted before the framework restarted.</span><br><span class="line">        // When encrypted device is booting, we get EROFS since</span><br><span class="line">        // FUSE hasn&#x27;t been created yet by init.</span><br><span class="line">        // In either case, continue without external storage.</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        RuntimeAbort(env, __LINE__, &quot;Cannot continue without emulated storage&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!is_system_server) &#123;</span><br><span class="line">        int rc = createProcessGroup(uid, getpid());</span><br><span class="line">        if (rc != 0) &#123;</span><br><span class="line">            if (rc == -EROFS) &#123;</span><br><span class="line">                ALOGW(&quot;createProcessGroup failed, kernel missing CONFIG_CGROUP_CPUACCT?&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                ALOGE(&quot;createProcessGroup(%d, %d) failed: %s&quot;, uid, pid, strerror(-rc));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SetGids(env, javaGids);</span><br><span class="line"></span><br><span class="line">    SetRLimits(env, javaRlimits);</span><br><span class="line"></span><br><span class="line">    if (use_native_bridge) &#123;</span><br><span class="line">      ScopedUtfChars isa_string(env, instructionSet);</span><br><span class="line">      ScopedUtfChars data_dir(env, dataDir);</span><br><span class="line">      android::PreInitializeNativeBridge(data_dir.c_str(), isa_string.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int rc = setresgid(gid, gid, gid);</span><br><span class="line">    if (rc == -1) &#123;</span><br><span class="line">      ALOGE(&quot;setresgid(%d) failed: %s&quot;, gid, strerror(errno));</span><br><span class="line">      RuntimeAbort(env, __LINE__, &quot;setresgid failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rc = setresuid(uid, uid, uid);</span><br><span class="line">    if (rc == -1) &#123;</span><br><span class="line">      ALOGE(&quot;setresuid(%d) failed: %s&quot;, uid, strerror(errno));</span><br><span class="line">      RuntimeAbort(env, __LINE__, &quot;setresuid failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (NeedsNoRandomizeWorkaround()) &#123;</span><br><span class="line">        // Work around ARM kernel ASLR lossage (http://b/5817320).</span><br><span class="line">        int old_personality = personality(0xffffffff);</span><br><span class="line">        int new_personality = personality(old_personality | ADDR_NO_RANDOMIZE);</span><br><span class="line">        if (new_personality == -1) &#123;</span><br><span class="line">            ALOGW(&quot;personality(%d) failed: %s&quot;, new_personality, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SetCapabilities(env, permittedCapabilities, effectiveCapabilities, permittedCapabilities);</span><br><span class="line"></span><br><span class="line">    SetSchedulerPolicy(env);</span><br><span class="line"></span><br><span class="line">    const char* se_info_c_str = NULL;</span><br><span class="line">    ScopedUtfChars* se_info = NULL;</span><br><span class="line">    if (java_se_info != NULL) &#123;</span><br><span class="line">        se_info = new ScopedUtfChars(env, java_se_info);</span><br><span class="line">        se_info_c_str = se_info-&gt;c_str();</span><br><span class="line">        if (se_info_c_str == NULL) &#123;</span><br><span class="line">          RuntimeAbort(env, __LINE__, &quot;se_info_c_str == NULL&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    const char* se_name_c_str = NULL;</span><br><span class="line">    ScopedUtfChars* se_name = NULL;</span><br><span class="line">    if (java_se_name != NULL) &#123;</span><br><span class="line">        se_name = new ScopedUtfChars(env, java_se_name);</span><br><span class="line">        se_name_c_str = se_name-&gt;c_str();</span><br><span class="line">        if (se_name_c_str == NULL) &#123;</span><br><span class="line">          RuntimeAbort(env, __LINE__, &quot;se_name_c_str == NULL&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    rc = selinux_android_setcontext(uid, is_system_server, se_info_c_str, se_name_c_str);</span><br><span class="line">    if (rc == -1) &#123;</span><br><span class="line">      ALOGE(&quot;selinux_android_setcontext(%d, %d, \&quot;%s\&quot;, \&quot;%s\&quot;) failed&quot;, uid,</span><br><span class="line">            is_system_server, se_info_c_str, se_name_c_str);</span><br><span class="line">      RuntimeAbort(env, __LINE__, &quot;selinux_android_setcontext failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Make it easier to debug audit logs by setting the main thread&#x27;s name to the</span><br><span class="line">    // nice name rather than &quot;app_process&quot;.</span><br><span class="line">    if (se_info_c_str == NULL &amp;&amp; is_system_server) &#123;</span><br><span class="line">      se_name_c_str = &quot;system_server&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (se_info_c_str != NULL) &#123;</span><br><span class="line">      SetThreadName(se_name_c_str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    delete se_info;</span><br><span class="line">    delete se_name;</span><br><span class="line"></span><br><span class="line">    UnsetSigChldHandler();</span><br><span class="line"></span><br><span class="line">    env-&gt;CallStaticVoidMethod(gZygoteClass, gCallPostForkChildHooks, debug_flags,</span><br><span class="line">                              is_system_server, instructionSet);</span><br><span class="line">    if (env-&gt;ExceptionCheck()) &#123;</span><br><span class="line">      RuntimeAbort(env, __LINE__, &quot;Error calling post fork hooks.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else if (pid &gt; 0) &#123;</span><br><span class="line">    // the parent process</span><br><span class="line"></span><br><span class="line">    // We blocked SIGCHLD prior to a fork, we unblock it here.</span><br><span class="line">    if (sigprocmask(SIG_UNBLOCK, &amp;sigchld, nullptr) == -1) &#123;</span><br><span class="line">      ALOGE(&quot;sigprocmask(SIG_SETMASK, &#123; SIGCHLD &#125;) failed: %s&quot;, strerror(errno));</span><br><span class="line">      RuntimeAbort(env, __LINE__, &quot;Call to sigprocmask(SIG_UNBLOCK, &#123; SIGCHLD &#125;) failed.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return pid;</span><br><span class="line">&#125;</span><br><span class="line">&#125;  // anonymous namespace</span><br></pre></td></tr></table></figure>
<p>同时在ZygoteInit中，我们可以发现，在fork出SystemServer后，Zygote会进入一个循环，等待 Activity Manager Service (AMS) 或其他进程来请求新的应用程序进程。这个循环是通过调用 <code>runSelectLoop</code> 方法实现的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">Runnable runSelectLoop(String abiList) &#123;</span><br><span class="line">        ArrayList&lt;FileDescriptor&gt; fds = new ArrayList&lt;FileDescriptor&gt;();</span><br><span class="line">        ArrayList&lt;ZygoteConnection&gt; peers = new ArrayList&lt;ZygoteConnection&gt;();</span><br><span class="line"></span><br><span class="line">        fds.add(mServerSocket.getFileDescriptor());</span><br><span class="line">        peers.add(null);</span><br><span class="line"></span><br><span class="line">        while (true) &#123;</span><br><span class="line">            StructPollfd[] pollFds = new StructPollfd[fds.size()];</span><br><span class="line">            for (int i = 0; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">                pollFds[i] = new StructPollfd();</span><br><span class="line">                pollFds[i].fd = fds.get(i);</span><br><span class="line">                pollFds[i].events = (short) POLLIN;</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                Os.poll(pollFds, -1);</span><br><span class="line">            &#125; catch (ErrnoException ex) &#123;</span><br><span class="line">                throw new RuntimeException(&quot;poll failed&quot;, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            for (int i = pollFds.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">                if ((pollFds[i].revents &amp; POLLIN) == 0) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (i == 0) &#123;</span><br><span class="line">                    ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class="line">                    peers.add(newPeer);</span><br><span class="line">                    fds.add(newPeer.getFileDesciptor());</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        ZygoteConnection connection = peers.get(i);</span><br><span class="line">                        final Runnable command = connection.processOneCommand(this);</span><br><span class="line"></span><br><span class="line">                        if (mIsForkChild) &#123;</span><br><span class="line">                            // We&#x27;re in the child. We should always have a command to run at this</span><br><span class="line">                            // stage if processOneCommand hasn&#x27;t called &quot;exec&quot;.</span><br><span class="line">                            if (command == null) &#123;</span><br><span class="line">                                throw new IllegalStateException(&quot;command == null&quot;);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            return command;</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            // We&#x27;re in the server - we should never have any commands to run.</span><br><span class="line">                            if (command != null) &#123;</span><br><span class="line">                                throw new IllegalStateException(&quot;command != null&quot;);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            // We don&#x27;t know whether the remote side of the socket was closed or</span><br><span class="line">                            // not until we attempt to read from it from processOneCommand. This shows up as</span><br><span class="line">                            // a regular POLLIN event in our regular processing loop.</span><br><span class="line">                            if (connection.isClosedByPeer()) &#123;</span><br><span class="line">                                connection.closeSocket();</span><br><span class="line">                                peers.remove(i);</span><br><span class="line">                                fds.remove(i);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; catch (Exception e) &#123;</span><br><span class="line">                        if (!mIsForkChild) &#123;</span><br><span class="line">                            // We&#x27;re in the server so any exception here is one that has taken place</span><br><span class="line">                            // pre-fork while processing commands or reading / writing from the</span><br><span class="line">                            // control socket. Make a loud noise about any such exceptions so that</span><br><span class="line">                            // we know exactly what failed and why.</span><br><span class="line"></span><br><span class="line">                            Slog.e(TAG, &quot;Exception executing zygote command: &quot;, e);</span><br><span class="line"></span><br><span class="line">                            // Make sure the socket is closed so that the other end knows immediately</span><br><span class="line">                            // that something has gone wrong and doesn&#x27;t time out waiting for a</span><br><span class="line">                            // response.</span><br><span class="line">                            ZygoteConnection conn = peers.remove(i);</span><br><span class="line">                            conn.closeSocket();</span><br><span class="line"></span><br><span class="line">                            fds.remove(i);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            // We&#x27;re in the child so any exception caught here has happened post</span><br><span class="line">                            // fork and before we execute ActivityThread.main (or any other main()</span><br><span class="line">                            // method). Log the details of the exception and bring down the process.</span><br><span class="line">                            Log.e(TAG, &quot;Caught post-fork exception in child process.&quot;, e);</span><br><span class="line">                            throw e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>总结：</p>
<p>Zygote 进程是从 init.rc 脚本中启动的。Zygote 进程本质上是一个服务端 Socket，它会一直运行，等待新的进程请求。在创建 Zygote 进程时，会携带 StartSystemServer 参数，这个参数会触发 Zygote 进程创建 SystemServer 子进程。SystemServer 进程是通过 Zygote 进程 fork 出来的，它的启动是由 ZygoteInit 通过反射的方式调用 SystemServer 的 main 方法实现的。</p>
<p>Zygote 进程在启动时创建了一个服务端 Socket，这个 Socket 用于与 SystemServer 进程的通信。当 SystemServer 进程创建完成后，Zygote 进程会关闭与 SystemServer 进程的 Socket 连接。此时，Zygote 进程已经完成了它的主要任务，它会进入一个循环，等待 Activity Manager Service (AMS) 或其他进程来请求新的应用程序进程。这个循环是通过调用 runSelectLoop 方法实现的。</p>
<p>请注意，Zygote 进程本身并不会关闭或销毁，它会一直运行，等待新的进程请求。而与 SystemServer 进程的 Socket 连接在 SystemServer 进程创建完成后就会关闭，因为此时已经没有必要维持这个连接了。</p>
<h4 id="SystemServer启动">SystemServer启动</h4>
<p>SystemServer是通过Zygote启动的，在ZygoteInit.java类的main通过forkSystemServer启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">    	....</span><br><span class="line">        <span class="comment">//设置变量区分是否启动SystemServer</span></span><br><span class="line">        <span class="keyword">boolean</span> startSystemServer = <span class="keyword">false</span>;</span><br><span class="line">    	String socketName = <span class="string">&quot;zygote&quot;</span>;</span><br><span class="line">    	String abiList = <span class="keyword">null</span>;</span><br><span class="line">    	<span class="keyword">boolean</span> enableLazyPreload = <span class="keyword">false</span>;</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class="line">        	<span class="keyword">if</span> (<span class="string">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">            	<span class="comment">// 需要启动时候，将标志位设置为true</span></span><br><span class="line">            	startSystemServer = <span class="keyword">true</span>;</span><br><span class="line">        	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;--enable-lazy-preload&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">            	enableLazyPreload = <span class="keyword">true</span>;</span><br><span class="line">        	&#125; </span><br><span class="line">        	... ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">                <span class="comment">// 通过 Zygote  fork 出 SystemServer </span></span><br><span class="line">                Runnable r = forkSystemServer(abiList, socketName, zygoteServer);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// &#123;@code r == null&#125; in the parent (zygote) process, and &#123;@code r != null&#125; in the</span></span><br><span class="line">                <span class="comment">// child (system_server) process.</span></span><br><span class="line">                <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>SystemServer启动入门main方法：</p>
<p>main入口通过<code>new SystemServer().run()</code>，开启SystemServer启动</p>
<p>main入口代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">	new SystemServer().run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到调用了SystemServer的run方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">private void run() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            traceBeginAndSlog(&quot;InitBeforeStartServices&quot;);</span><br><span class="line">            //初始化时间</span><br><span class="line">            if (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) &#123;</span><br><span class="line">                Slog.w(TAG, &quot;System clock is before 1970; setting to 1970.&quot;);</span><br><span class="line">                SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            //设置默认时区</span><br><span class="line">            String timezoneProperty =  SystemProperties.get(&quot;persist.sys.timezone&quot;);</span><br><span class="line">            if (timezoneProperty == null || timezoneProperty.isEmpty()) &#123;</span><br><span class="line">                Slog.w(TAG, &quot;Timezone not set; setting to GMT.&quot;);</span><br><span class="line">                SystemProperties.set(&quot;persist.sys.timezone&quot;, &quot;GMT&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            ... ... </span><br><span class="line"> </span><br><span class="line">            // 开始进入Android SystemServer</span><br><span class="line">            Slog.i(TAG, &quot;Entered the Android system server!&quot;);</span><br><span class="line">            int uptimeMillis = (int) SystemClock.elapsedRealtime();</span><br><span class="line">            EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, uptimeMillis);</span><br><span class="line">            if (!mRuntimeRestart) &#123;</span><br><span class="line">                MetricsLogger.histogram(null, &quot;boot_system_server_init&quot;, uptimeMillis);</span><br><span class="line">            &#125;</span><br><span class="line">            ... ...</span><br><span class="line"> </span><br><span class="line">            //如果支持指纹，需初始化指纹ro.build.fingerprint</span><br><span class="line">            Build.ensureFingerprintProperty();</span><br><span class="line"> </span><br><span class="line">            ... ...</span><br><span class="line">                </span><br><span class="line">            // 初始化 native services.</span><br><span class="line">            System.loadLibrary(&quot;android_servers&quot;);</span><br><span class="line"> </span><br><span class="line">            // 检查最近一次关机是否失败</span><br><span class="line">            performPendingShutdown();</span><br><span class="line"> </span><br><span class="line">            // 初始化 the system context.</span><br><span class="line">            createSystemContext();</span><br><span class="line"> </span><br><span class="line">            // 创建 system service manager.</span><br><span class="line">            mSystemServiceManager = new SystemServiceManager(mSystemContext);</span><br><span class="line">            mSystemServiceManager.setStartInfo(mRuntimeRestart,</span><br><span class="line">                    mRuntimeStartElapsedTime, mRuntimeStartUptime);</span><br><span class="line">            LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line">            // 初始化SystemServer 线程池</span><br><span class="line">            SystemServerInitThreadPool.get();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            traceEnd();  // InitBeforeStartServices</span><br><span class="line">        &#125;</span><br><span class="line">         ... ...</span><br><span class="line">         </span><br><span class="line">        // 开始启动 services.</span><br><span class="line">        try &#123;</span><br><span class="line">            traceBeginAndSlog(&quot;StartServices&quot;);</span><br><span class="line">        // 1. 启动引导服务  详见分析六</span><br><span class="line">            startBootstrapServices();</span><br><span class="line">            // 2. 启动核心服务  详见分析七</span><br><span class="line">            startCoreServices();</span><br><span class="line">            // 3.启动其他服务  详见分析八</span><br><span class="line">            startOtherServices();</span><br><span class="line">            SystemServerInitThreadPool.shutdown();</span><br><span class="line">        &#125; catch (Throwable ex) &#123;</span><br><span class="line">            Slog.e(&quot;System&quot;, &quot;******************************************&quot;);</span><br><span class="line">            Slog.e(&quot;System&quot;, &quot;************ Failure starting system services&quot;, ex);</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            traceEnd();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        StrictMode.initVmDefaults(null);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>从run方法中，我们可以看到SystemServer的启动主要做了以下工作：</p>
<ol>
<li>进行启动时间、日志、heapprofd、严苛模式等性能采集相关的基本设置，以及进程优先级、binder、虚拟机内存等保障SystemServer正常运行的基本设置。</li>
<li>创建SystemContext上下文</li>
<li>创建SystemServiceManager，通过startBootstrapServices（关键引导服务）、startCoreServices（核心服务）、startOtherServices（其他各路混杂的服务）、startApexServices等启动各类服务</li>
<li>启动looper。</li>
</ol>
<p>在startBootstrapServices、startCoreServices、startOtherServices、startApexServices中，对各类服务进行了启动，比如我们常见的ActivityManagerService、PackageManagerService、BatteryService等等，共近百个Service。而对Service启动的方式是相似的，以startBootstrapServices为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有很复杂的依赖关系，所以要优先启动    </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">&quot;Reading configuration...&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> String TAG_SYSTEM_CONFIG = <span class="string">&quot;ReadingSystemConfig&quot;</span>;</span><br><span class="line">        traceBeginAndSlog(TAG_SYSTEM_CONFIG);</span><br><span class="line">        SystemServerInitThreadPool.get().submit(SystemConfig::getInstance, TAG_SYSTEM_CONFIG);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wait for installd to finish starting up so that it has a chance to</span></span><br><span class="line">        <span class="comment">// create critical directories such as /data/user with the appropriate</span></span><br><span class="line">        <span class="comment">// permissions.  We need this to complete before we initialize other services.</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartInstaller&quot;</span>);</span><br><span class="line">        Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In some cases after launching an app we need to access device identifiers,</span></span><br><span class="line">        <span class="comment">// therefore register the device identifier policy before the activity manager.</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;DeviceIdentifiersPolicyService&quot;</span>);</span><br><span class="line">        mSystemServiceManager.startService(DeviceIdentifiersPolicyService.class);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Activity manager runs the show.</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartActivityManager&quot;</span>);</span><br><span class="line">        mActivityManagerService = mSystemServiceManager.startService(</span><br><span class="line">                ActivityManagerService.Lifecycle.class).getService();</span><br><span class="line">        mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">        mActivityManagerService.setInstaller(installer);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Power manager needs to be started early because other services need it.</span></span><br><span class="line">        <span class="comment">// Native daemons may be watching for it to be registered so it must be ready</span></span><br><span class="line">        <span class="comment">// to handle incoming binder calls immediately (including being able to verify</span></span><br><span class="line">        <span class="comment">// the permissions for those calls).</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartPowerManager&quot;</span>);</span><br><span class="line">        mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now that the power manager has been started, let the activity manager</span></span><br><span class="line">        <span class="comment">// initialize power management features.</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;InitPowerManagement&quot;</span>);</span><br><span class="line">        mActivityManagerService.initPowerManagement();</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Bring up recovery system in case a rescue party needs a reboot</span></span><br><span class="line">        <span class="keyword">if</span> (!SystemProperties.getBoolean(<span class="string">&quot;config.disable_noncore&quot;</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            traceBeginAndSlog(<span class="string">&quot;StartRecoverySystemService&quot;</span>);</span><br><span class="line">            mSystemServiceManager.startService(RecoverySystemService.class);</span><br><span class="line">            traceEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now that we have the bare essentials of the OS up and running, take</span></span><br><span class="line">        <span class="comment">// note that we just booted, which might send out a rescue party if</span></span><br><span class="line">        <span class="comment">// we&#x27;re stuck in a runtime restart loop.</span></span><br><span class="line">        RescueParty.noteBoot(mSystemContext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Manages LEDs and display backlight so we need it to bring up the display.</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartLightsService&quot;</span>);</span><br><span class="line">        mSystemServiceManager.startService(LightsService.class);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Display manager is needed to provide display metrics before package manager</span></span><br><span class="line">        <span class="comment">// starts up.</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartDisplayManager&quot;</span>);</span><br><span class="line">        mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We need the default display before we can initialize the package manager.</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;WaitForDisplay&quot;</span>);</span><br><span class="line">        mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Only run &quot;core&quot; apps if we&#x27;re encrypting the device.</span></span><br><span class="line">        String cryptState = SystemProperties.get(<span class="string">&quot;vold.decrypt&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ENCRYPTING_STATE.equals(cryptState)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Detected encryption in progress - only parsing core apps&quot;</span>);</span><br><span class="line">            mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ENCRYPTED_STATE.equals(cryptState)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Device encrypted - only parsing core apps&quot;</span>);</span><br><span class="line">            mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start the package manager.</span></span><br><span class="line">        <span class="keyword">if</span> (!mRuntimeRestart) &#123;</span><br><span class="line">            MetricsLogger.histogram(<span class="keyword">null</span>, <span class="string">&quot;boot_package_manager_init_start&quot;</span>,</span><br><span class="line">                    (<span class="keyword">int</span>) SystemClock.elapsedRealtime());</span><br><span class="line">        &#125;</span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartPackageManagerService&quot;</span>);</span><br><span class="line">        mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">                mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">        mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line">        mPackageManager = mSystemContext.getPackageManager();</span><br><span class="line">        traceEnd();</span><br><span class="line">        <span class="keyword">if</span> (!mRuntimeRestart &amp;&amp; !isFirstBootOrUpgrade()) &#123;</span><br><span class="line">            MetricsLogger.histogram(<span class="keyword">null</span>, <span class="string">&quot;boot_package_manager_init_ready&quot;</span>,</span><br><span class="line">                    (<span class="keyword">int</span>) SystemClock.elapsedRealtime());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Manages A/B OTA dexopting. This is a bootstrap service as we need it to rename</span></span><br><span class="line">        <span class="comment">// A/B artifacts after boot, before anything else might touch/need them.</span></span><br><span class="line">        <span class="comment">// Note: this isn&#x27;t needed during decryption (we don&#x27;t have /data anyways).</span></span><br><span class="line">        <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> disableOtaDexopt = SystemProperties.getBoolean(<span class="string">&quot;config.disable_otadexopt&quot;</span>,</span><br><span class="line">                    <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (!disableOtaDexopt) &#123;</span><br><span class="line">                traceBeginAndSlog(<span class="string">&quot;StartOtaDexOptService&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    OtaDexoptService.main(mSystemContext, mPackageManagerService);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">&quot;starting OtaDexOptService&quot;</span>, e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    traceEnd();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartUserManagerService&quot;</span>);</span><br><span class="line">        mSystemServiceManager.startService(UserManagerService.LifeCycle.class);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize attribute cache used to cache resources from packages.</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;InitAttributerCache&quot;</span>);</span><br><span class="line">        AttributeCache.init(mSystemContext);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the Application instance for the system process and get started.</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;SetSystemProcess&quot;</span>);</span><br><span class="line">        mActivityManagerService.setSystemProcess();</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// DisplayManagerService needs to setup android.display scheduling related policies</span></span><br><span class="line">        <span class="comment">// since setSystemProcess() would have overridden policies due to setProcessGroup</span></span><br><span class="line">        mDisplayManagerService.setupSchedulerPolicies();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Manages Overlay packages</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartOverlayManagerService&quot;</span>);</span><br><span class="line">        mSystemServiceManager.startService(<span class="keyword">new</span> OverlayManagerService(mSystemContext, installer));</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The sensor service needs access to package manager service, app ops</span></span><br><span class="line">        <span class="comment">// service, and permissions service, therefore we start it after them.</span></span><br><span class="line">        <span class="comment">// Start sensor service in a separate thread. Completion should be checked</span></span><br><span class="line">        <span class="comment">// before using it.</span></span><br><span class="line">        mSensorServiceStart = SystemServerInitThreadPool.get().submit(() -&gt; &#123;</span><br><span class="line">            TimingsTraceLog traceLog = <span class="keyword">new</span> TimingsTraceLog(</span><br><span class="line">                    SYSTEM_SERVER_TIMING_ASYNC_TAG, Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">            traceLog.traceBegin(START_SENSOR_SERVICE);</span><br><span class="line">            startSensorService();</span><br><span class="line">            traceLog.traceEnd();</span><br><span class="line">        &#125;, START_SENSOR_SERVICE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>而在startOtherServices中，对有这样一些处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">(<span class="meta">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    ServiceManager.addService(<span class="string">&quot;scheduling_policy&quot;</span>, <span class="keyword">new</span> SchedulingPolicyService());</span><br><span class="line">    mSystemServiceManager.startService(ACCOUNT_SERVICE_CLASS);</span><br><span class="line">    wm = <span class="function">Window </span></span><br><span class="line"><span class="function">new <span class="title">PhoneWindowManager</span><span class="params">()</span>,     mActivityManagerService.mActivityTaskManager)</span>;</span><br><span class="line">    ServiceManager.addService(Context.WINDOW_SERVICE, wm, <span class="comment">/* allowIsolated= */</span> <span class="keyword">false</span>, DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);</span><br><span class="line">    mActivityManagerService.setWindowManager(wm);</span><br><span class="line">    ...</span><br><span class="line">    mSystemServiceManager.startServiceFromJar(</span><br><span class="line">                        WIFI_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>startOtherServices里处理的服务要比其他三个方法里庞杂的多，但综上，SystemServer对服务的管理主要有以下方式：</p>
<p>mSystemServiceManager.startService – 启动一个服务<br>
mSystemServiceManager.startBootPhase – 广播所有已启动的服务当前的启动阶段<br>
ServiceManager.addService – 将服务纳入ServiceManager进行管理<br>
ServiceManager是一个handler为0的binder service，将服务addServer(key, service)到ServiceManager后，可以通过key轻松获取对应服务。所有SystemServer启动的Service都被加入到了ServiceManager中。因此后续直接通过key获取到对应Service的binder服务端</p>
<p>SystemServiceManager是SystemServer在本地集中启动、管理各Service的管理类，所有Service必须继承SystemService</p>
<p>用下面的图来表示各个角色的关系：</p>
<p><img src="https://img-blog.csdnimg.cn/direct/b67a3743dc6747edb48ba91e5592ed8c.png" alt=""></p>
<p>使用<code>service list</code>命令可以查看有多少服务</p>
<h4 id="system-server获取HomeActivity及启动对应进程">system_server获取HomeActivity及启动对应进程</h4>
<p>我们知道在<code>startOtherService</code>里面不仅仅会<code>start</code>系统服务，等系统服务都启动完成后，还会调用各个<code>Service</code>的<code>systemReady</code>方法，这里需要分析首个<code>Activity</code>的启动，即常见的<code>Launcher</code>，当然是从<code>ActivityManagerService</code>开始分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback, TimingsTraceLog traceLog)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 省略</span></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">       <span class="comment">// 省略</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 省略</span></span><br><span class="line">        startHomeActivityLocked(currentUserId, <span class="string">&quot;systemReady&quot;</span>);</span><br><span class="line">  		 <span class="comment">// 省略</span></span><br><span class="line">        mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">          <span class="comment">// 省略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​	这里对大部分不是分析的核心代码进行了省略，这里看到了<code>startHomeActivityLocked(currentUserId, “systemReady”);</code>被调用，从名字既可以看得出他是要启动<code>Home</code>类型的<code>Activtiy</code>，常见的<code>Launcher</code>就是一种<code>Home</code>类型的<code>Activity</code>，但这里其实并不是<code>Launcher</code>，而是设置中的<code>FallbackHome</code>类型的，它也是一个<code>Home</code>类型的<code>Activity</code>，这里<code>FallbackHome</code>是<code>google</code>新加入的，主要就是因为涉及整个<code>android</code>系统的加密等原因，系统在还没有完全解锁前，不可以启动<code>Launcher</code>，因为<code>Launcher</code>中明显和各个第三方应用耦合较多（比如桌面可能显示着一堆的各个应用的<code>Widget</code>），如果直接<code>Launcher</code>作为<code>FallbackHome</code>启动，相对就会要求<code>Launcher</code>依赖的应用也是支持直接解密类型，那就肯定不现实。所以就先启动了<code>FallbackHome</code>一个什么也不显示的界面来作为启动真正<code>Launcher</code>的一个过度。</p>
<p>那来分析一下，到底是怎么启动<code>FallbackHome</code>，又是凭什么确定就是<code>FallbackHome</code>？接下来继续分析<code>startHomeActivityLocked</code>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startHomeActivityLocked</span><span class="params">(<span class="keyword">int</span> userId, String reason)</span> </span>&#123;</span><br><span class="line"><span class="comment">//省略</span></span><br><span class="line"> 		Intent intent = getHomeIntent();<span class="comment">//获取Home类型的Intent</span></span><br><span class="line">       ActivityInfo aInfo = resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);<span class="comment">//通过PackageManagerService查询出目前系统中可以匹配这个intent的ActivtiyInfo</span></span><br><span class="line">       <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">           intent.setComponent(<span class="keyword">new</span> ComponentName(aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line">           aInfo = <span class="keyword">new</span> ActivityInfo(aInfo);</span><br><span class="line">           aInfo.applicationInfo = getAppInfoForUser(aInfo.applicationInfo, userId);</span><br><span class="line">           <span class="comment">//判断进程是否启动</span></span><br><span class="line">           ProcessRecord app = getProcessRecordLocked(aInfo.processName,</span><br><span class="line">                   aInfo.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">           <span class="keyword">if</span> (app == <span class="keyword">null</span> || app.instr == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">//省略。。</span></span><br><span class="line">               mActivityStarter.startHomeActivityLocked(intent, aInfo, myReason);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; </span><br><span class="line">    <span class="comment">//省略</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Intent <span class="title">getHomeIntent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       Intent intent = <span class="keyword">new</span> Intent(mTopAction, mTopData != <span class="keyword">null</span> ? Uri.parse(mTopData) : <span class="keyword">null</span>);</span><br><span class="line">       intent.setComponent(mTopComponent);</span><br><span class="line">       intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);</span><br><span class="line">       <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">       <span class="comment">//这里是匹配HomeIntent的核心</span></span><br><span class="line">           intent.addCategory(Intent.CATEGORY_HOME);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> intent;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里的<code>getHomeIntent</code>主要就是在<code>Intent</code>中增加 <code>intent.addCategory(Intent.CATEGORY_HOME);</code>即有<code>category</code>为<code>Intent.CATEGORY_HOME</code>的<code>Intent</code><br>
这里面比较简单，就是获取了<code>HomeIntent</code>后，然后利用<code>intent</code>进行<code>ActivityInfo</code>获取，然后判断是否还没有启动过该进程，没有则继续调用<code>mActivityStarter.startHomeActivityLocked(intent, aInfo, myReason);</code>调用<code>ActivityStarter</code>里面的<code>startHomeActivityLocked</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startHomeActivityLocked</span><span class="params">(Intent intent, ActivityInfo aInfo, String reason)</span> </span>&#123;</span><br><span class="line">    mSupervisor.moveHomeStackTaskToTop(reason);</span><br><span class="line">    mLastHomeActivityStartResult = startActivityLocked(<span class="keyword">null</span> <span class="comment">/*caller*/</span>, intent,</span><br><span class="line">                                                       <span class="keyword">null</span> <span class="comment">/*ephemeralIntent*/</span>, <span class="keyword">null</span> <span class="comment">/*resolvedType*/</span>, aInfo, <span class="keyword">null</span> <span class="comment">/*rInfo*/</span>,</span><br><span class="line">                                                       <span class="keyword">null</span> <span class="comment">/*voiceSession*/</span>, <span class="keyword">null</span> <span class="comment">/*voiceInteractor*/</span>, <span class="keyword">null</span> <span class="comment">/*resultTo*/</span>,</span><br><span class="line">                                                       <span class="keyword">null</span> <span class="comment">/*resultWho*/</span>, <span class="number">0</span> <span class="comment">/*requestCode*/</span>, <span class="number">0</span> <span class="comment">/*callingPid*/</span>, <span class="number">0</span> <span class="comment">/*callingUid*/</span>,</span><br><span class="line">                                                       <span class="keyword">null</span> <span class="comment">/*callingPackage*/</span>, <span class="number">0</span> <span class="comment">/*realCallingPid*/</span>, <span class="number">0</span> <span class="comment">/*realCallingUid*/</span>,</span><br><span class="line">                                                       <span class="number">0</span> <span class="comment">/*startFlags*/</span>, <span class="keyword">null</span> <span class="comment">/*options*/</span>, <span class="keyword">false</span> <span class="comment">/*ignoreTargetSecurity*/</span>,</span><br><span class="line">                                                       <span class="keyword">false</span> <span class="comment">/*componentSpecified*/</span>, mLastHomeActivityStartRecord <span class="comment">/*outActivity*/</span>,</span><br><span class="line">                                                       <span class="keyword">null</span> <span class="comment">/*inTask*/</span>, <span class="string">&quot;startHomeActivity: &quot;</span> + reason);</span><br><span class="line">    <span class="keyword">if</span> (mSupervisor.inResumeTopActivity) &#123;</span><br><span class="line">        <span class="comment">// If we are in resume section already, home activity will be initialized, but not</span></span><br><span class="line">        <span class="comment">// resumed (to avoid recursive resume) and will stay that way until something pokes it</span></span><br><span class="line">        <span class="comment">// again. We need to schedule another resume.</span></span><br><span class="line">        mSupervisor.scheduleResumeTopActivities();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又调用 <code>startActivity(r, sourceRecord, voiceSession, voiceInteractor, startFlags, true,options, inTask, outActivity);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="params"><span class="function">                          IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="params"><span class="function">                          ActivityRecord[] outActivity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//省略</span></span><br><span class="line">    mService.mWindowManager.deferSurfaceLayout();</span><br><span class="line">    result = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class="line">                                    startFlags, doResume, options, inTask, outActivity);</span><br><span class="line">    <span class="comment">//省略</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里又调用到<code>startActivityUnchecked</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="params"><span class="function">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="params"><span class="function">     </span></span></span><br><span class="line"><span class="params"><span class="function">	//省略</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">if</span> (mDoResume)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//省略</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//省略</span></span><br><span class="line">            mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,</span><br><span class="line">                    mOptions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//省略</span></span><br><span class="line">    <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里用会调用到<code>ActivityStackSupervisor</code>的<code>resumeFocusedStackTopActivityLocked</code>方法：<br>
<code>mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,mOptions);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">resumeFocusedStackTopActivityLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> </span>&#123;</span><br><span class="line"><span class="comment">//省略</span></span><br><span class="line">        <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">            <span class="keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//省略</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Android跨进程从入门到精通">Android跨进程从入门到精通</h3>
<p>binder对于Android系统非常重要，无binder无Android，binder是安卓系统的任督二脉，如果有人问你android相比linux有什么特点，那Android的binder绝对为最大特点。</p>
<p>常见的binder跨进程通信方式：</p>
<ul>
<li>利用Service组件binderService方式获取Binder通信
<ul>
<li>其实这种方法也是先通过ServiceManager获取到对应的AMS，然后再通过AMS相关接口方法传递IBinder对象</li>
</ul>
</li>
<li>直接通过ServiceManager.getService方式获取相关Manager，其实就是IBinder</li>
</ul>
<p>那么如何实现跨进程通信呢：</p>
<p>首先我们需要定义服务端</p>
<ul>
<li>定义好C/S架构中要通信的接口，一般使用aidl文件</li>
<li>编写一个继承服务端Service组件，且注册到Manifest，这个如果C/S都在同一个工程包下需要把Service独立进程运行</li>
<li>服务端Service对aidl定义的接口的内部Stub接口进行实现和构造成一个IBinder对象，通过Service的onBinder方法进行返回</li>
</ul>
<p>然后定义客户端：</p>
<ul>
<li>构造一个Intent，包含远程Service，包含类名</li>
<li>调用bindService，在ServiceConnection的onServiceConnected方法中获取了服务端返回的IBinder对象</li>
<li>直接使用服务端写好的aidl文件，调用对应的IBinder接口对象的方法，看着像是本地方法的调用，实际上已经调用了远端。</li>
</ul>
<ol>
<li>定义aidl文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">interface IStudentInterface &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Demonstrates some basic types that you can use as parameters</span><br><span class="line">     * and return values in AIDL.</span><br><span class="line">     */</span><br><span class="line">//    void basicTypes(int anInt, long aLong, boolean aBoolean, float aFloat,</span><br><span class="line">//            double aDouble, String aString);</span><br><span class="line"></span><br><span class="line">    int getStudentId(String name);</span><br><span class="line">    void setCallback(IChangeCallback callback);</span><br><span class="line"></span><br><span class="line">    String getConvertName(in StudentInfo info);</span><br><span class="line">    void getServiceStudentInfo(out StudentInfo serviceInfo);</span><br><span class="line"></span><br><span class="line">    void getServiceStudentInfoInOut(inout StudentInfo serviceInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>编写一个继承服务端的Service组件</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Return the communication channel to the service.</span></span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line">    IChangeCallback mCallBack = <span class="keyword">null</span>;</span><br><span class="line">    IStudentInterface.Stub mBinder = <span class="keyword">new</span> IStudentInterface.Stub() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getStudentId</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (name.equals( <span class="string">&quot;helloworld&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mCallBack!= <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot; mCallBack changeData result = &quot;</span> + mCallBack.changeData(<span class="number">1111</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span>  <span class="number">10</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCallback</span><span class="params">(IChangeCallback callback)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            mCallBack = callback;</span><br><span class="line">            mCallBack.asBinder().linkToDeath(<span class="keyword">new</span> DeathRecipient() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;linkToDeath binderDied&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getConvertName</span><span class="params">(StudentInfo info)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (info!=<span class="keyword">null</span>) &#123;</span><br><span class="line">                info.name = <span class="string">&quot;hello,this is ConvertName &quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> info.name;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getServiceStudentInfo</span><span class="params">(StudentInfo serviceInfo)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot; getServiceStudentInfo out serviceInfo = &quot;</span> + serviceInfo);</span><br><span class="line">            serviceInfo.id = <span class="string">&quot;100&quot;</span>;</span><br><span class="line">            serviceInfo.name = <span class="string">&quot;this is Service modify out&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getServiceStudentInfoInOut</span><span class="params">(StudentInfo serviceInfo)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot; getServiceStudentInfo inout serviceInfo = &quot;</span> + serviceInfo);</span><br><span class="line">            serviceInfo.id = <span class="string">&quot;-100&quot;</span>;</span><br><span class="line">            serviceInfo.name = <span class="string">&quot;this is Service modify in out&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;MyService onCreate&quot;</span>);</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;MyService onStartCommand intent = &quot;</span> + intent );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;MyService onDestroy&quot;</span>);</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:name</span>=<span class="string">&quot;.MyService&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:process</span>=<span class="string">&quot;:myservice&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>客户端对服务端的调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">FloatingActionButton fab = findViewById(R.id.fab);</span><br><span class="line">        fab.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>,MyService.class);</span><br><span class="line">            <span class="comment">//    startService(intent);</span></span><br><span class="line">                bindService(intent, <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">                        IStudentInterface remoteInterface = IStudentInterface.Stub.asInterface(service);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            remoteInterface.setCallback(<span class="keyword">new</span> CallbackeService());</span><br><span class="line">                            Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;client onServiceConnected remoteInterface getStudentId = &quot;</span> + remoteInterface.getStudentId(<span class="string">&quot;helloworld&quot;</span>));</span><br><span class="line">                            Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;client onServiceConnected remoteInterface getStudentId = &quot;</span> + remoteInterface.getStudentId(<span class="string">&quot;no&quot;</span>));</span><br><span class="line">                            <span class="comment">/***************************************************************/</span></span><br><span class="line">                            StudentInfo studentInfoIn = <span class="keyword">new</span> StudentInfo();</span><br><span class="line">                            studentInfoIn.setId(<span class="string">&quot;200&quot;</span>);</span><br><span class="line">                            studentInfoIn.setName(<span class="string">&quot;client&quot;</span>);</span><br><span class="line">                            Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;client onServiceConnected remoteInterface getConvertName = &quot;</span> +remoteInterface.getConvertName(studentInfoIn ) + <span class="string">&quot; studentInfoIn = &quot;</span> + studentInfoIn);</span><br><span class="line">                            <span class="comment">/***************************************************************/</span></span><br><span class="line">                            StudentInfo studentInfoOut = <span class="keyword">new</span> StudentInfo();</span><br><span class="line">                            studentInfoOut.setId(<span class="string">&quot;200+&quot;</span>);</span><br><span class="line">                            studentInfoOut.setName(<span class="string">&quot;clientOut&quot;</span>);</span><br><span class="line">                            remoteInterface.getServiceStudentInfo(studentInfoOut);</span><br><span class="line">                            Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;client onServiceConnected remoteInterface getServiceStudentInfo = &quot;</span> + studentInfoOut);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">/***************************************************************/</span></span><br><span class="line">                            StudentInfo studentInfoInOut = <span class="keyword">new</span> StudentInfo();</span><br><span class="line">                            studentInfoInOut.setId(<span class="string">&quot;2001&quot;</span>);</span><br><span class="line">                            studentInfoInOut.setName(<span class="string">&quot;clientInOut&quot;</span>);</span><br><span class="line">                            remoteInterface.getServiceStudentInfoInOut(studentInfoInOut);</span><br><span class="line">                            Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;client onServiceConnected remoteInterface getServiceStudentInfoInOut = &quot;</span> + studentInfoInOut);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">                        Log.i(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;client onServiceDisconnected name = &quot;</span> +name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, BIND_AUTO_CREATE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<h4 id="binder的aidl工具生成java源码分析">binder的aidl工具生成java源码分析</h4>
<ul>
<li>为什么要有aidl，它存在的意义是什么</li>
</ul>
<p>aidl最后会通过一个.exe把整个aidl文件转换为对应的Java文件，那么为什么不直接使用Java文件呢？</p>
<p>有下面两个原因</p>
<ul>
<li>如果使用Java语言，要编写很多重复的固定的代码，代码量大，稍不小心容易出错</li>
<li>这一部分可以让脚本根据某些配置文件来生成对应的Java代码，而这个配置文件正类似我们看到的aidl文件</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">THYLOVEZQ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/06/25/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91/%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/">http://example.com/2024/06/25/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91/%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">THYLOVEZQ的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/25/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91/%E7%9F%AD%E8%A7%86%E9%A2%91app/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2024/06/25/python/python/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./img/2.jfif" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">THYLOVEZQ</div><div class="author-info__description">THYLOVEZQ的小家,欢迎访问</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">86</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/THYLOVEZJ"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/THYLOVEZJ" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:thy1105864486@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#handler"><span class="toc-number">1.</span> <span class="toc-text">handler</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#handler%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">handler的原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#binder"><span class="toc-number">2.</span> <span class="toc-text">binder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8binder"><span class="toc-number">2.1.</span> <span class="toc-text">为什么使用binder</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Framework"><span class="toc-number">3.</span> <span class="toc-text">Framework</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%BC%96%E8%AF%91Android%E6%BA%90%E7%A0%81"><span class="toc-number">3.1.</span> <span class="toc-text">如何编译Android源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%AA%E4%BA%9B%E4%BB%A3%E7%A0%81%E6%98%AF%E8%BF%90%E8%A1%8C%E5%9C%A8App%E8%BF%9B%E7%A8%8B%E7%9A%84"><span class="toc-number">3.2.</span> <span class="toc-text">哪些代码是运行在App进程的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#framework%E7%9A%84%E7%BC%96%E8%AF%91%E4%BA%A7%E7%89%A9"><span class="toc-number">3.3.</span> <span class="toc-text">framework的编译产物</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Activity%E7%9A%84%E5%90%AF%E5%8A%A8"><span class="toc-number">3.4.</span> <span class="toc-text">Activity的启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-%E5%8E%BB%E9%99%A4%E5%B9%BF%E5%91%8A%E9%A1%B5"><span class="toc-number">3.5.</span> <span class="toc-text">[实战开发]去除广告页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%B0%86%E7%BC%96%E8%AF%91%E7%9A%84%E7%B3%BB%E7%BB%9F%E6%94%BE%E5%88%B0Windows%E4%B8%8B%E6%89%A7%E8%A1%8C"><span class="toc-number">3.6.</span> <span class="toc-text">如何将编译的系统放到Windows下执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Android%E7%B3%BB%E7%BB%9F%E5%86%85%E7%BD%AE%E5%BA%94%E7%94%A8"><span class="toc-number">3.7.</span> <span class="toc-text">Android系统内置应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB"><span class="toc-number">3.8.</span> <span class="toc-text">安卓开机动画</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB%E5%BC%80%E5%A7%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.8.1.</span> <span class="toc-text">安卓开机动画开始源码分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB%E7%9A%84%E7%BB%93%E6%9D%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.8.2.</span> <span class="toc-text">开机动画的结束源码分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BBopenGL%E7%BB%98%E5%88%B6%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E6%88%98"><span class="toc-number">3.8.3.</span> <span class="toc-text">开机动画openGL绘制分析及实战</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90zip%E5%8C%85%E7%9A%84%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="toc-number">3.8.4.</span> <span class="toc-text">开机动画源码分析zip包的运行原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E5%88%B6%E4%BD%9Cbootanimation"><span class="toc-number">3.8.5.</span> <span class="toc-text">实战制作bootanimation</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Android-native%E5%B1%82thread%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">3.9.</span> <span class="toc-text">Android native层thread实现方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B2%BF%E7%94%A8linux%E4%B8%8A%E7%9A%84posix%E7%BA%BF%E7%A8%8B%E6%96%B9%E6%A1%88"><span class="toc-number">3.9.1.</span> <span class="toc-text">沿用linux上的posix线程方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#android%E5%9C%A8native%E5%B1%82%E9%9D%A2%E5%B0%81%E8%A3%85%E7%9A%84thread%E7%B1%BB"><span class="toc-number">3.9.2.</span> <span class="toc-text">android在native层面封装的thread类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">3.9.3.</span> <span class="toc-text">实战</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zygote%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.10.</span> <span class="toc-text">Zygote启动流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Zygote%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.10.1.</span> <span class="toc-text">Zygote简单介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Zygote%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">3.10.2.</span> <span class="toc-text">Zygote启动脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Zygote%E8%BF%9B%E8%A1%8Cfork%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.10.3.</span> <span class="toc-text">Zygote进行fork进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SystemServer%E5%90%AF%E5%8A%A8"><span class="toc-number">3.10.4.</span> <span class="toc-text">SystemServer启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#system-server%E8%8E%B7%E5%8F%96HomeActivity%E5%8F%8A%E5%90%AF%E5%8A%A8%E5%AF%B9%E5%BA%94%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.10.5.</span> <span class="toc-text">system_server获取HomeActivity及启动对应进程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Android%E8%B7%A8%E8%BF%9B%E7%A8%8B%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A"><span class="toc-number">3.11.</span> <span class="toc-text">Android跨进程从入门到精通</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#binder%E7%9A%84aidl%E5%B7%A5%E5%85%B7%E7%94%9F%E6%88%90java%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.11.1.</span> <span class="toc-text">binder的aidl工具生成java源码分析</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/06/25/openGL/" title="无题"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2024/06/25/openGL/" title="无题">无题</a><time datetime="2024-06-25T14:57:58.527Z" title="发表于 2024-06-25 22:57:58">2024-06-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/25/openEMS/" title="无题"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2024/06/25/openEMS/" title="无题">无题</a><time datetime="2024-06-25T14:57:58.525Z" title="发表于 2024-06-25 22:57:58">2024-06-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/25/FDTD/" title="无题"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2024/06/25/FDTD/" title="无题">无题</a><time datetime="2024-06-25T14:57:58.514Z" title="发表于 2024-06-25 22:57:58">2024-06-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/25/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91/" title="无题"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2024/06/25/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91/" title="无题">无题</a><time datetime="2024-06-25T14:57:58.506Z" title="发表于 2024-06-25 22:57:58">2024-06-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/25/%E6%95%B0%E6%8D%AE%E5%BA%93/redis/" title="无题"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2024/06/25/%E6%95%B0%E6%8D%AE%E5%BA%93/redis/" title="无题">无题</a><time datetime="2024-06-25T14:57:58.466Z" title="发表于 2024-06-25 22:57:58">2024-06-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By THYLOVEZQ</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>